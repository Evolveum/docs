= Design
:page-since: 4.8
:page-toc: top

WARNING: This page is a work in progress.

== Upgrade steps

. Use _midpoint.home_ to configure connection to midPoint repository
. Check if midPoint is *NOT* running.
. Verify objects in repository
. Initial objects
.. *TODO:* How to update existing ones
. Upgrade DB schema
. Update midpoint.home
. Update binaries


== Opened questions for meeting

* How to update object during upgrade procedure?
** When reading object with old repository impl, we can't update is according to new one
** When reading object with new repository impl, we will not get any info about elements that were removed.
Currently, only warning to log - if schema migration exist, else exception is thrown.
* Objects upgrade in database
** What if we want to dry run objects upgrade to review changes?
*** I'd verify objects and execute upgrade on them but then store delta in h2 table (as report from tool).
How to dump delta otherwise for many objects?
* Should administrator stop all tasks before upgrade?
* How can upgrade tool upload objects (with recompute) if we're only on repo layer?
* How to wrap up upgrade after new version was started
** What if upgrade process needs to recompute something?
* Tech stack
** Spring shell or plain jcommander lib (with jansi)?
** Spring batch? Is this necessary? Multithreading jobs/steps. Probably not worth it.
* Audit logs - how to upgrade, if needed?
** First option
*** Upgrade schema for existing tables
**** Can take too long if new columns have default values, or new indexes have to be created
** Second option
*** Move existing tables
*** Create new ones
*** Update ID sequence to `max(ID) + 1` from old tables
*** Copy data from old tables to new ones if necessary
* Initial objects
** diff previous version with next (how to display changes)
** diff next version with current state of repository (how to display delta)

