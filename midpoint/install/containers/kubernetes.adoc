= Vanilla Kubernetes
:page-nav-title: Vanilla Kubernetes
:toc: float-right
:toclevels: 4
:page-keywords:  [ 'insatll', 'kubernetes' ]

{% for v in site.data.midpoint-versions %}{% if v.status == null or v.status == "released" %}{% assign lastReleased = v %}{% endif %}{% endfor %}

This page is related to the midPoint in container context of documentation.
Here will be dedicated samples related to the vanilla kubernetes.

You may be interested in :

* common xref:../[container]  related information +
There is information contains possibilities of customization of the installation.

* xref:./docker/[docker] related information +
Sample configuration related to the docker environment.

[NOTE]
====
Page is under construction.
Please check the page soon for new content.
====

== Prepare to start

When we are starting the environment we have to address few steps to have successful start of application.

* <<namespace>> (optional) +
There is native isolation concept in kubernetes to group the objects - namespaces.
Even it is not mandatory we recommend to create the namespace to keep the configuration logically grouped.

* repository +
The repository is the relational database where the midPoint's objects are stored.
At the moment of start the repository have to be available and initiated at least on structure level (tables, indexes, etc.).
The definitions for postgreSQL are delivered with the midPoint container.
Initial objects (the content) will be handled by the midPoint itself if needed.

** Init empty structure +
The midPoint can handle the content of DB.
The structure of the repository have to be prepared in advance.
It can be run explicitly one time before first run.
It can be also the part of Init container as conditional block of the code.

** update structure +
Once you have initialized repository there may be need to update the schema with version change - upgrade.
This is usually one time operation with the upgrade.
The upgrade of database schema not necessarily have to be needed with all the midPoint's release - see the xref:/midpoint/release[] page to check if needed.

* required files on filesystem
** configuration file - config.xml +
There have to be proper content of the *config.xml* to be able to start.
Some part can be set / overwritten via environment variables.
** keystore - keystore.jceks +
The keystore is generated automatically in case it is missing.
If you need any additional content (e.g. certificate to establish secured connection to resource) you have to handle explicitly.

* modPoint home
** volumes +

** access "hidden files" behind the mount points

== Starting the environment

To start the environment we need several objects.
We can group them by the type / purpose:

* StatefulSet +
Control objects which provide template for the pods including the scale - amount of requested instance.
+
.repository definition without persistent storage | link:https://raw.githubusercontent.com/Evolveum/midpoint-kubernetes/main/base-environment/statefulset-db-w_o-init.yaml[Github]
[%collapsible]
====
[source,yaml]
----
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mp-demo-db
  namespace: mp-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mp-demo-db
  template:
    metadata:
      labels:
        app: mp-demo-db
    spec:
      containers:
        - name: mp-demo-db
          image: 'postgres:16-alpine'
          ports:
            - name: db
              containerPort: 5432
              protocol: TCP
          env:
            - name: POSTGRES_INITDB_ARGS
              value: '--lc-collate=en_US.utf8 --lc-ctype=en_US.utf8'
            - name: POSTGRES_USER
              value: midpoint
            - name: POSTGRES_PASSWORD
              value: SuperSecretPassword007
          imagePullPolicy: IfNotPresent
      restartPolicy: Always
      terminationGracePeriodSeconds: 10
  serviceName: mp-demo-db
----
====
+
.midPoint without persistent storage
[%collapsible]
====
[source,yaml]
----
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mp-pg-demo
  namespace: mp-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mp-pg-demo
  template:
    metadata:
      labels:
        app: mp-pg-demo
    spec:
      volumes:
        - name: mp-home
          emptyDir: {}
      initContainers:
        - name: mp-config-init
          image: 'evolveum/midpoint:{{ lastReleased.version }}-alpine'
          command: [ "/bin/bash", "-c" ]
          args:
            - cd /opt/midpoint ;
              bin/midpoint.sh init-native ;
              echo ' - - - - - - ' ;
              bin/ninja.sh -B info >/dev/null 2>/tmp/ninja.log ;
              grep -q "ERROR" /tmp/ninja.log && (
              bin/ninja.sh -B run-sql --create --mode REPOSITORY  ;
              bin/ninja.sh -B run-sql --create --mode AUDIT
              ) ||
              echo -e '\\n Repository init is not needed...' ;
          env:
            - name: MP_SET_midpoint_repository_database
              value: postgresql
            - name: MP_SET_midpoint_repository_jdbcUsername
              value: midpoint
            - name: MP_SET_midpoint_repository_jdbcPassword
              value: SuperSecretPassword007
            - name: MP_SET_midpoint_repository_jdbcUrl
              value: jdbc:postgresql://mp-demo-db.mp-demo.svc.cluster.local:5432/midpoint
          volumeMounts:
            - name: mp-home
              mountPath: /opt/midpoint/var
          imagePullPolicy: IfNotPresent
      containers:
        - name: mp-pg-demo
          image: 'evolveum/midpoint:{{ lastReleased.version }}-alpine'
          ports:
            - name: gui
              containerPort: 8080
              protocol: TCP
          env:
            - name: MP_SET_midpoint_repository_database
              value: postgresql
            - name: MP_SET_midpoint_repository_jdbcUsername
              value: midpoint
            - name: MP_SET_midpoint_repository_jdbcPassword
              value: SuperSecretPassword007
            - name: MP_SET_midpoint_repository_jdbcUrl
              value: jdbc:postgresql://mp-demo-db.mp-demo.svc.cluster.local:5432/midpoint
            - name: MP_UNSET_midpoint_repository_hibernateHbm2ddl
              value: "1"
            - name: MP_NO_ENV_COMPAT
              value: "1"
          volumeMounts:
            - name: mp-home
              mountPath: /opt/midpoint/var
          imagePullPolicy: IfNotPresent
  serviceName: mp-pg-demo
----
====

* Service +
"Meeting point" for the use case.
As pods has dynamic IPs there are not available IP addresses in advance.
The service "scan" for the pods with the specific set of the labels (metadata).
Once the match is found the IP is added to the endpoint list for the service.
The name of service is known and it can be used for the connection (e.g. midPoint contact the repository using service definition).
+
.repository
[%collapsible]
====
[source,yaml]
----
kind: Service
apiVersion: v1
metadata:
  name: mp-demo-db
  namespace: mp-demo
  labels:
    app: mp-demo-db
spec:
  ports:
    - protocol: TCP
      port: 5432
      targetPort: 5432
  selector:
    app: mp-demo-db
  type: ClusterIP
  sessionAffinity: None
----
====
+
.midPoint
[%collapsible]
====
[source,yaml]
----
kind: Service
apiVersion: v1
metadata:
  name: mp-demo-mp
  namespace: mp-demo
  labels:
    app: mp-demo-mp
spec:
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
  selector:
    app: mp-demo-mp
  type: ClusterIP
  sessionAffinity: None
----
====

* Ingress +
Entry point for the user.
It is reverse proxy - first point of contact for the communication from outside on shared ports (http - TCP/80, https - TCP/443).
Once the definition match the communication is passed to the defined service.

* _pod_ +
The pods is not defined directly by default.
It is result of the statefulSet definition.

.base object used for the environment
image::kubernetes-diagram.png[]


== Used object for the definition

[#namespace]
=== Namespace

To have grouped configuration logically separated from the rest of the objects it is good approach to create the namespace.

.Example of the *mp-demo* namespace definition | link:https://raw.githubusercontent.com/Evolveum/midpoint-kubernetes/main/base-environment/namespace-mp-demo.yaml[Github]
[source,yaml]
----
apiVersion: v1
kind: Namespace
metadata:
  name: mp-demo
spec:
  finalizers:
    - kubernetes
----

[WARNING]
====
Once you remove the namespace object from Kubernetes all the objects located in the namespace are also removed.
====

=== Repository

With the repository there are two expected cases where we will need to do some operation.

==== Init repository (DB schema)

Ther

[source,yaml]
----
  volumes:
    - name: mp-home
      emptyDir: {}
  initContainers:
    - name: mp-config-init
      image: 'evolveum/midpoint:4.8.1-alpine'
      command: [ "/bin/bash", "-c" ]
      args:
        - cd /opt/midpoint ;
          bin/midpoint.sh init-native ;
          echo ' - - - - - - ' ;
          bin/ninja.sh -B info >/dev/null 2>/tmp/ninja.log ;
          grep -q "ERROR" /tmp/ninja.log && (
          bin/ninja.sh -B run-sql --create --mode REPOSITORY  ;
          bin/ninja.sh -B run-sql --create --mode AUDIT
          ) ||
          echo -e '\\n Repository init is not needed...' ;
      env:
        - name: MP_INIT_CFG
          value: /opt/midpoint/var
        - name: MP_SET_midpoint_repository_database
          value: 'postgresql'
        - name: MP_SET_midpoint_repository_jdbcUsername
          value: 'midpoint'
        - name: MP_SET_midpoint_repository_jdbcPassword
          value: 'SuperSecretPassword007'
        - name: MP_SET_midpoint_repository_jdbcUrl
          value: 'jdbc:postgresql://midpoint-data:5432/midpoint'
      volumeMounts:
        - name: mp-home
          mountPath: /opt/midpoint/var
      imagePullPolicy: IfNotPresent
----

== configuration files
For the native repository there is need to have proper configuration for the db connection.
This configuration is stored in *config.xml* located in midPoint home directory.

To have it ready you have several options how to handle it.

* *configmap* mounted to the pod's filesystem
* *secret* mounted to the pod's filesystem
* *Persistent Volume Claim*
* handle it dynamically in the *initContainer*

