= Vanilla Kubernetes
:page-nav-title: Vanilla Kubernetes
:page-display-order: 30
:page-toc: float-right
:toclevels: 4
:page-keywords:  [ 'insatll', 'kubernetes' ]

{% for v in site.data.midpoint-versions %}{% if v.status == null or v.status == "released" %}{% assign lastReleased = v %}{% endif %}{% endfor %}

This page is related to the midPoint in container context of documentation.
Here will be dedicated samples related to the vanilla kubernetes.

You may be interested in :

* common xref:../[container]  related information +
There is information contains possibilities of customization of the installation.

* xref:./docker/[docker] related information +
Sample configuration related to the docker environment.

[NOTE]
====
Page is under construction.
Please check the page soon for new content.
====

== Deployment

=== Simple deployment

[#simpldepl]
.simple deployment in kubernetes
image::kubernetes-diagram.png[]

To start the environment we need several objects.
We can group them by the type / purpose:

* StatefulSet +
Control objects which provide template for the pods including the scale - amount of requested instance.

* Service +
"Meeting point" for the use case - internal transparent proxy for communication.
As pods has dynamic IPs the IP addresses is assigned after pod creation.
The name of service is known in advance.
It can be used for the connection (e.g. midPoint contact the repository using service definition).

* Ingress +
Entry point for the user.
It is reverse proxy - first point of contact for the communication from outside on shared ports (http - TCP/80, https - TCP/443).
Once the definition match the communication is passed to the defined service.

* _Pod_ +
The pods is not defined directly in this deployment.
It is result of the statefulSet definition.
+
Technically it is the place where the application is running.
The other objects are about to create the pod with proper configuration and make the reachable

=== Simple deployment with PVC and secret
[#simplpvcdepl]
.simple deployment with PVC and secret in kubernetes
image::kubernetes-diagram-pvc_secret.png[]

This diagram extend the Simple one with two objects.

* Persistent Volume Claim (PVC) +
To keep data persistent over the container re-creation we need external storage space.

* Secret +
Object for keeping sensitive information for the use with the Pod(s).
It target situation of shared password (e.g. to access the DB we need to "share" the credentials between the DB server and the client connecting into it).

== Working with deployment

=== Prepared object definition

We have prepared the definition for you.
It is located in our link:https://github.com/evolveum/midpoint-kubernetes[github] repository (link:https://github.com/Evolveum/midpoint-kubernetes/archive/refs/heads/main.zip[download ZIP]).

For the next steps you need to have the content available locally.
One of the option is to use the link pointing to the ZIP file and unzip it.

[NOTE]
====
The commands mentioned here suppose to be run in the terminal / command line.

`kubectl` is used to communicate with kubernetes cluster.
It is supposed you have working setting allowing you to connect, authenticate and communicate with the kubernetes cluster.

To test you can try to requset list of nodes in the cluster : `kubectl get nodes`.

In case you face any issue with kubectl please refer kubernetes documentation how to make it work.
====

=== Simple deployment

For the <<simpldepl,simple deployment>> there is important the path `./deployment/simple`.

[WARNING]
====
The simple environment all data store in dynamic (non-persistent) store.
In case of pod removing all the related data is deleted.

Please note that it is not possible to partially restart the environment in this scenario.
In case you restart DB your repository is lost.
In case you restart midPoint the key to access encrypted data in repository is lost.

This configuration is good for quick testing, demo, etc.
====

.Apply the configuration to create the midpoint environment
[source,bash]
----
kubectl apply -f ./deployment/simple
----

.output from the *apply* command
[%collapsible]
====
namespace/midpoint-deployment created +
service/midpoint-repository created +
service/midpoint created +
ingress.networking.k8s.io/midpoint created +
statefulset.apps/midpoint-repository created +
statefulset.apps/midpoint created
====

.Delete the objects related to the midpoint environment
[source,bash]
----
kubectl delete -f ./deployment/simple
----

.output from the *delete* command
[%collapsible]
====
namespace "midpoint-deployment" deleted +
service "midpoint-repository" deleted +
service "midpoint" deleted +
ingress.networking.k8s.io "midpoint" deleted +
statefulset.apps "midpoint-repository" deleted +
statefulset.apps "midpoint" deleted
====

The objects are prepared to use own namespace - logical group of the objects.
In the provided files it is creating and using the namespace called *midpoint-deployment*.

[#ingressnote]
All the objects except ingress definition can be used as is.
In relation with the Ingress definition there should be addressed few topics:

* *ingresClassName* +
In the definition there is expected presence of *nginx*.
In case you don't have it in kubernetes environment this option has to be updated to correspond with your kubernetes environment setting.

* tls +
There will be used default certificate for https.
In case you want to use different one it should be explicitly set in the ingress definition.

[#simple-host]
* host +
There is set host *midpoint.example.com*.
To have it working you should make this value resolvable - to be able to get IP address.
Here is some options how to reach it ( any of them should be sufficient ) :

** set the record to */etc/hosts* file (C:\Windows\System32\drivers\etc\hosts in case of windows)

** set the static record on your local DNS resolver

** change the value (FQDN) to something else what is under your control

Once the environment is created it takes several seconds to get it up and running.
First run can take longer as the image have to be downloaded from public registry - docker hub.

The environment will be available with following information:

[#accessinfo]
.Access information
[%noheader%autowidth]
|====
|URL:| https://midpoint.example.com ^(1)^

|Username: | administrator

|Initial password: | Test5ecr3t ^(2)^

|====

. on the kubernetes site the FQDN is set using <<simple-host,ingress>> object

. The init password is generated by default. In the statefulset definition for midpoint it is forced to be this value. +
MP_SET_midpoint_administrator_initialPassword=Test5ecr3t

=== Simple deployment with PVC and secret

For the <<simplpvcdepl,simple deployment with PVC and secret>> there is important the path `./deployment/simple-pvc`.

[WARNING]
====
The *repository data* and *midpoint home data* are stored on Persistent Volume Claim.
It is kept even in case the Pod is removed - it is not removed with the *statefulset* definition.

On the other side in case of test(s) there may be present data in the environment from the previous run(s).

Please note that even it is dedicated object(s) it is still part of namespace.
In case we are removing namespace all member objects are removed even it is not directly addressed.
This statement cover also PVC in the namespace.
====

.Apply the configuration to create the midpoint environment
[source,bash]
----
kubectl apply -f ./deployment/simple-pvc
----

.output from the *apply* command
[%collapsible]
====
namespace/midpoint-deployment created +
secret/midpoint-repository created +
service/midpoint-repository created +
service/midpoint created +
ingress.networking.k8s.io/midpoint created +
statefulset.apps/midpoint-repository created +
statefulset.apps/midpoint created
====

There is not explicitly defined any PVC.
The definition is "hidden" in the statefulset where is section *volumeClaimTemplates*.

.Volume sizing in the provided yaml definitions
[%autowidth]
|====
| Pod's name | Volume size

| midPoint
| 128 MB

| repository
| 5 GB
|====

The PVC is created based on the template value with the first run.
In case the PVC already exists it is directly used (e.g. re-create the pod).

.Delete the objects related to the midpoint environment
[source,bash]
----
kubectl delete -f ./deployment/simple-pvc
----

.output from the *delete* command
[%collapsible]
====
namespace "midpoint-deployment" deleted +
secret "midpoint-repository" deleted +
service "midpoint-repository" deleted +
service "midpoint" deleted +
ingress.networking.k8s.io "midpoint" deleted +
statefulset.apps "midpoint-repository" deleted +
statefulset.apps "midpoint" deleted
====

[WARNING]
====
PVC definition belong to the namespace.
Once you are removing also namespace all contained objects are removed before namespace itself.

In case you want to keep the PVC (data storage) don't remove the namespace - e.g. temporarily move the yaml definition for the namespace out of the simple-pvc directory.
====

The <<ingressnote,Ingress>> information and <<accessinfo,Access>> information is the same as in the case of simple deployment.

== TODO

* kubernetes object example
** ConfigMaps
*** composed definition

* Post initial Objects example

* Keystore
** options how to handle - PVC, secret
** certificate to resource connection

* Cloud installaction
** scaling
** sessino affinity