= Generate usernames in midPoint for new users
:page-nav-title: Generate usernames in midPoint
:page-display-order: 410
:page-toc: top
:experimental:
:icons: font
:page-moved-from: /midpoint/methodology/first-steps/automate-target-system-integration/

Up until now, you sourced usernames from the target LDAP resource (the only inbound mapping we had for the target system).
This approach works well for existing accounts that already have the username populated in the LDAP resource,
but what about new users?
Once HR department registers a new user in the HRIS, the account gets arrives to midPoint, but it has no place from which to obtain the username.

Let us change that.
Similarly to passwords, midPoint can generate usernames as well.
The difference here is that passwords are random strings, while usernames consist, typically, of the first and last names and possibly some numbers.
For this reason, you are going to use a script for this task.

== What awaits you in this module

To generate usernames, you will:

. Archive both the HRIS and LDAP inbound mappings for the `name` attribute as they are not going to be needed any longer.
. Use the Person object template to define new mapping for username generation.
    The mapping will be _weak_ so that it does not overwrite existing values.
. Create new users in the source HRIS resource.
. Use import preview for to check whether generating usernames works correctly.
. Create a recurring HRIS reconciliation task to import new users automatically on regular basis.

When you are done, you will have automated generation of usernames that are link:https://learn.microsoft.com/en-us/windows/win32/adschema/a-samaccountname[sAMAccountName]-compatible, and set up an interval-based recurring reconciliation task to import the HRIS accounts without a human operator like you needing to run the reconciliation task manually.

:sectnums:

== Archive obsolete mappings

In the beginning, you have used the `empnum` containing employee number from the HRIS source system as a unique value for the _name_ attribute (which needs to be unique.
Later on, after you have connected the LDAP target system, you have replaced it with `uid` which contains usernames, at least in our example training data.

However, you have already imported all the pre-existing users from the target system to midPoint and reconciled them,
hence there is no need for either of the mappings and you can *archive them*.

Start with the HRIS mapping:

. Go to the source HRIS resource > [.nowrap]#icon:male[] *Accounts*# > mapping configuration.
. In [.nowrap]#icon:arrow-right-to-bracket[] *Inbound*# mappings, find the mapping that copies the unique attribute from HRIS to the focal object _name_ attribute.
    In our guide here, its name is _empnum-to-name_.
. Set its lifecycle to _Archived_.

When done, *do exactly the same with the LDAP target resource* attribute mapping you used to map LDAP usernames to the _name_ focus attribute in midPoint.
In our guide here, its name is _inbound-uid-username-to-name_.

[TIP]
====
We use the _Archived_ lifecycle state here to indicate that the mapping is unlikely to be active again.
For temporary mapping deactivation, you could use the _Suspended_ state.
All _Archived_, _Suspended_, and _Draft_ states represent deactivated mappings,
but midPoint has those three states to express different reasons for mapping deactivation.
====

== Add username mapping to Person object template

Object template is a configuration object in midPoint you can use to run mappings whenever a focal object, such as a user, is created or updated in midPoint.

Refer to xref:/midpoint/reference/expressions/object-template/[] and xref:/midpoint/reference/schema/archetypes/person/[] for more details.

The Person object template already contains out-of-the-box a mapping to generate full name.
You have seen it in action when you assigned the Person archetype to users imported from the HRIS source system.

What you are after now is a mapping that would take the given name and surname, and generate a username in the _jsmith82_ format that conforms to the Active Directory sAMAccountName restrictions.
Such a username consists of the first letter from the given name, concatenates it with the surname, and takes 8 characters from the result.
Moreover, if the result is not unique in the system (e.g., _Alice Baker_ and _Andrew Baker_ result both in _abaker_), the mapping needs to add up to two digits to make the usernames unique (_abaker2_.._abaker99_).
It is a usual to start with the number iterator on _2_ to make the usernames more human friendly and intuitive: _abaker_, _abaker2_, _abaker3_, …

.Person object template mapping to generate jsmith82-style usernames
image::person-object-template-mapping-generate-jsmith82-username.webp["Person object template mapping to generate jsmith82-style usernames"]

To add a new mapping to generate the _jsmith82_ usernames:

. In [.nowrap]#icon:file-alt[] *Object templates*# > [.nowrap]#icon:file-alt[] *All object templates*#, select *Person Object Template*.
. In [.nowrap]#icon:circle[] *Mappings*#, click [.nowrap]#icon:plus[] btn:[New]# to create a new mapping.
    ** If you use the pre-configured Docker images for this guide, the username mapping is already there.
        Inspect it to see what it does.
. *Name* the mapping, e.g., _generate-name-jsmith-8-2_.
. Set *Lifecycle state* to _Active_.
    ** You can safely activate the mapping for it is _weak_ and will never overwrite existing values.
. Set *Strength* to _weak_ so that the mapping does not overwrite existing data on the resource.
. Select _givenName_ and _familyName_ from _Focus_ in *Source*.
. Set the *expression* to _Script_.
    ** See the script below.
. Set *Target* to _name_ as that is the unique identifying attribute for focal objects.
. Click btn:[Done] in the mapping details and [.nowrap]#icon:save[] btn:[Save]# in the overview screen to save your settings.

.The script to use for generating jsmith82 usernames
[source,groovy]
----
tmpGivenName = basic.trim(basic.norm(basic.stringify(givenName))) <1>
tmpFamilyName  = basic.trim(basic.norm(basic.stringify(familyName))) <1>
tmpGivenNameInitial = tmpGivenName?.take(1) <2>
return (tmpGivenNameInitial + tmpFamilyName?.replaceAll(" ", ""))?.take(8) + iterationToken <3>
----
<1>Take the xref:/midpoint/reference/schema/polystring-normalization/[normalized version of the name string] and remove leading and trailing white characters using `trim()`.
<2>Truncate the first name only to one character. This is safe even if `firstName` is empty, but it cannot be null.
<3>Concatenate the first name initial with the surname, shorten it to 8 characters if needed, remove white spaces, and add the xref:/midpoint/reference/concepts/iteration/[iteration token].

== Add new users in source system to test username generation

With the object template mapping ready, it is time to put it to test.
Create new users in your source system and import them to midPoint.

If you use the training Docker images prepared for this guide, use the Demo HR app (under `http://localhost/hr/`).
Otherwise, register new users to your own source system; you can use the data from below as a template for inspiration.

. In the Demo HR app under link:http://localhost/hr/[http://localhost/hr/], click btn:[Register user] on the top of the screen.
. Fill in the values from the table below.
. Confirm by clicking btn:[Register user] beneath the form.
. Click btn:[Export users to CSV file] at the bottom of the page to export the users.
. In midPoint, run simulated import task to preview the changes.

.Users to be added
[cols="h,5*"]
|=======================================================================================================
| First name          | Louise                        | Andreas | Clara        | Clara        | Jacques
| Surname             | Callahan                      | Baker   | Whiteherring | Whiteherring | Smith
| Employee number     | 9000                          | 9001    | 9002         | 9003         | 9004
| Locality         5+^| White Stone City
| Job              5+^| 222#Export/Import Coordinator
| EmpType          5+^| FTE
| Status           5+^| In
|=======================================================================================================

== Simulate importing new users to midPoint

. In [.nowrap]#icon:database[] *Resources*# > [.nowrap]#icon:database[] *All resources*#, go to the the source HRIS resource.
. In [.nowrap]#icon:male[] *Accounts*#, click [.nowrap]#icon:rotate-right[] btn:[Reload]# at the bottom of the list to make midPoint aware of the new accounts.
. Pick one of the new accounts and select btn:[▼] > *Import preview* at the far right.
. Select *Simulated production* and click btn:[Select].
. Observe the _name_ attribute being filled in with a proper username instead of the employee number.

.Result of preview import operation showing successfully generated username
image::hris-preview-import-with-jsmith82-username.webp["Result of preview import operation showing successfully generated username"]

After you verify the configuration works for you, import the users to midPoint for real.

== Automate importing users to midPoint

Refer to xref:/midpoint/reference/tasks/synchronization-tasks/import-and-reconciliation/gui/[] for a guide on working with tasks in GUI.

. Create a new task with the simulation toggle off.
. Name it, e.g., _HR Reconciliation_.
. Set the schedule interval to, e.g., 60 seconds.
    ** This makes the task automated, running every 60 seconds,
        meaning every time new accounts appear in the source CSV, they get automatically imported to midPoint.
        In a real scenario, you would probably set the interval to minutes or hours.
. Save the task and run it.

Wait until the task finishes its first run and head over to [.nowrap]#icon:user[] *Users*# > [.nowrap]#icon:user[] *Persons*#
to see the newly added users and their generated jsmith82-style usernames.

You can filter them out, e.g., by the employee number (mapped to `personalNumber`) using the advanced filter like this:

.Query to filter users by their `personalNumber` attribute
[source, groovy]
----
personalNumber startsWith '900'
----

.Users newly imported to the HRIS resource with jsmith82-style usernames generated by midPoint
image::hris-persons-with-jsmith82-usernames.webp["Users newly imported to the HRIS resource with jsmith82-style usernames generated by midPoint"]

// Lab 8-1 also mentions looking into the audit log viewer to see what midPoint did. This could be covered in an article on reading audit logs. @dakle 2025-11-12

:sectnums!:

== What is next

You have automated sAMAccountName-compatible username generation.
You have also automated reconciliation of the source HRIS resource with midPoint,
which means that every time a user is created in and exported from the HRIS, the account is imported to midPoint as well.

The next step is to ensure that every person in midPoint has an account in LDAP provisioned automatically.