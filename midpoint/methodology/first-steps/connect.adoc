= Connect the Source and Target Systems
:page-nav-title: 'Connect Source and Target'
:page-display-order: 110
:page-toc: top
:experimental:
:icons: font

.Goal
[TIP]
====
Now that you know what systems you need to manage, it's time to connect them to midPoint and assess the quality of the data you're dealing with.
Use this step to identify serious security risks, such as orphaned accounts.
You'll also get to know how consistent your data are across the systems.
You can use this knowledge to improve your plan based on _real_ data.
====

Let us repeat that for the purposes of this guide, we suppose you have an HR system that exports CSV files with accounts and an Active Directory system implemented using LDAP.
The HR system is considered to be an authoritative source, the AD/LDAP system is considered to be a non-authoritative target system.

Whatever your actual systems are, the concepts presented in this guide are universal and you need to adjust only the implementation details, such as your resource configuration.

.Sample data to test with
[NOTE]
====
If you firstly wish to test the scenarios described in this guide, you can use fictitious sample HR system export CSV file:

* xref:../hris-export-sample.csv[hris-export-sample.csv]

Place is to the home directory of your midPoint instance. See xref:/midpoint/quickstart/#file-paths-in-docker-containers[how to work with file paths in Docker].

Obviously, the caveat of having a static CSV file to test with is that when you want to imitate a change in the HR system, you need to edit the CSV file manually.
====

== Considerations Before You Connect the Source System

In theory, you should give the data in your _source_ HR system absolute authority and use it to fix any inconsistencies in other _target_ systems, such as an Active Directory or other resources.

Reality isn't so straightforward, though.

* Firstly, there are almost certainly errors in the HR data.
    They're managed manually with no automatic validation.
    Having nothing to compare the data with makes it impossible to assess their quality.

* Secondly, target systems like Active Directory are managed by different people and also manually.
    There may be outdated information, such as old names of people who changed their names.
    More serious issues like orphaned accounts of former employees can occur.
    These issues are fairly easy to fix through synchronization with the HR resource, though.

* Thirdly, not all Active Directory accounts need to exist in the HR system.
    Your AD admins may have created some service accounts.
    These aren’t employees and therefore aren't in the HR system.
    That means an HR-based synchronization without proper planning would delete these potentially business-critical accounts.

Overall, when integrating an IGA solution on top of existing account data, *you need to be vigilant*:

* You can't change *usernames* carelessly.
  Many systems in your organization may use them as the primary ID of accounts.

* You mustn't delete any *accounts* unless you're absolutely sure it's the desired action.

* You have to keep *passwords* as they are.
  Otherwise, you'd lock people out of the systems across your organization.

== Connect the HR System

The first thing to do is to connect the authoritative source system to midPoint.
When you're done with this step, you're going to have the HR accounts in midPoint and can move forth with connecting a target system, such as an Active Directory.

=== Create a Resource for the HR System

The HR system exports accounts to CSV files.
A CSV file can be a resource like any other.
To get users from CSV to midPoint, use the CSV connector and configure it according to the structure of the CSV export.

*Use the xref:/midpoint/reference/admin-gui/resource-wizard/create-resource-using-wizard/[guide on connecting a resource to midPoint] to help you with the configuration.*

. Create a new resource from scratch.
. Use the CSV connector.
. Set the lifecycle state to _Proposed_ until you finish the whole configuration of the resource.
. Get back here when you're done.

=== Configure the HR Resource Object Type

The next step after connecting the CSV resource is to configure the resource object type.
In your case, each resource object represents a user account in the HR system.

*Use this guide for xref:/midpoint/reference/admin-gui/resource-wizard/object-type/[instructions on object type configuration].*

. Name the object type _HR Person_, for example.
. The type will be of the _Account_ kind, _default_ (or empty) intent, and with the _Default_ attribute set to _True_.
. Select the _Person_ archetype in the last step.
. Keep the rest of the settings to defaults.
. Get back here when you're done.

After you save your object type, you can preview the resource data to see what you're getting from the resource.

=== Filter Out Irrelevant HR Entries

When you preview the resource objects, you may realize there are some accounts that you don't want or need to manage using midPoint.

These may be AC technicians or people who manage your office greenery.
While their work is indispensable, they simply have no IT accounts to manage.

To prevent these accounts from being imported to midPoint:

. Find a common pattern these entries have in the HR system. +
    It may be that their employee numbers start with a different digit or their employment type is different from others…

. xref:/midpoint/reference/admin-gui/resource-wizard/object-type[Go back to the object type configuration] and select the icon:circle[] *Basic attributes* tile.

. Edit the object type you've created for the accounts and xref:/midpoint/reference/admin-gui/resource-wizard/object-type#filter-resource-objects[set up a filtering query]. +
    For instance, to exclude employees whose number (`empnum`) starts with `8`: `attributes/empnum not startsWith "8"`.

. Save the object and preview the resource objects again.

. xref:/midpoint/reference/tasks/shadow-reclassification-task/[Reclassify the resource object shadows] to reflect your changes in the account list.

. The excluded accounts should no longer appear among the accounts. MidPoint is aware of them but they are no longer considered an _HR Person_ (they are of an unknown kind and intent).

Now, you're ready to proceed to the next steps before you can import your users from the HR system to midPoint.
The next steps are:

* Mapping rules
* Synchronization rules

=== Define Mappings and Synchronization Policies

Before you can import any user accounts, you need to define user data handling, as well as specify synchronization rules on how to behave when users are discovered, updated, deleted, and so on.
This is what mappings and synchronization policies are for.

Both the synchronization and mapping rules can be set as _Active_ because the whole resource is still in the _Proposed_ lifecycle state.
Lifecycle states can be considered hierarchical in this case.
Refer to xref:/midpoint/reference/concepts/object-lifecycle/[] for more details about lifecycle states.

==== Set synchronization rules

Firstly, let's tell midPoint what to do in what situation.

* Refer to this guide on creating synchronization rules: xref:/midpoint/reference/admin-gui/resource-wizard/object-type/synchronization/[]

These are the rules to define at this stage of your project:

[cols="2,1,1,1,4"]
|====
| Name | Situation | Reaction | Lifecycle state | Comments

| add-focus-for-unmatched
| Unmatched
| Add focus
| Active
| The account from CSV doesn't exist in midPoint yet, so let's create the user in midPoint.

// technically not needed in clean MP but they need to add it later anyway so I'm putting it here already @dakle
| link-unlinked
| Unlinked
| Link
| Active
| There's a focus for the account but it's not linked to the shadow of the account yet, let's link it. This isn't used during the first import, but it's necessary for later when the account shadows are in midPoint already.

| synchronize-linked
| Linked
| Synchronize
| Active
| Synchronize the data between the remote account and the focus based on mappings.

|====

[TIP]
====
See xref:/midpoint/features/current/synchronization/[] to learn about the topic in more depth.
====

==== Map user data

Secondly, you need to map various data in the user objects on the resource to user attributes in midPoint.

* Refer to this guide on creating mapping rules: xref:/midpoint/reference/admin-gui/resource-wizard/object-type/mapping/[].

* Use *inbound mappings* because you're pulling attributes _from_ the resource _to_ midPoint.

See xref:/midpoint/features/current/mapping/[] to learn about the topic in more depth.

Below are the rules to define now.
Your source attribute names may be different based on your source system attribute naming.

[cols="2,1,1,1,1,5"]
|====
| Name | Source | Expression | Target | Lifecycle state | Comments

| empnum-to-name
| `empnum`
| As is
| `name`
| Active
| Name must be unique so the employee number is the best choice now. Later, you can generate unique usernames, for example.

| empnum-to-personalNumber
| `empnum`
| As is
| `personalNumber`
| Active
| empnum is also important for employee identification so we map it to another dedicated parameter. It'll stay there even after you create unique usernames.

| firstName-to-givenName
| `firstName`
| As is
| `givenName`
| Active
| We'll construct a full name from first and last names.

| surname-to-familyName
| `surname`
| As is
| `familyName`
| Active
|

| locality-to-locality
| `locality`
| As is
| `locality`
| Active
| User location can be later used with the full name for a last-resort correlation.

| status-to-lifecycleState
| `status`
| Script
| `lifecycleState`
| Active
| Find the script to use beneath the table.

|====

[[mapping-script]]
.The status-to-lifecycleState mapping conversion script
[source,groovy]
----
switch (input) {
   case 'In':
      'active'
      break

   case 'Long-term leave':
      'suspended'
      break

   case 'Former employee':
      'archived'
      break
}
----

image::../hris-inbound-mappings.webp[title="Inbound mapping list for the HR resource"]

.Naming conventions for mapping names
[NOTE]
====
You may be curious about why we name the mappings as shown above.
At first glance, it seems unnecessary to name the mapping _surname-to-familyName_
since it is evident that it takes _surname_ as input and outputs its content to _familyName_.

You are correct, but the rationale behind this naming convention is that *mapping names must be unique within the object type*.
This approach helps to ensure that.

As for spaces vs. dashes—you can use either, but dashes are generally the saver option.
====

=== Make the Resource Read-Only

If you're dealing with a resource the data of which you don't want to change, it's best to adjust the xref:/midpoint/reference/resources/resource-configuration/capabilities/[configured capabilities] of the resource so that mistakes can't happen.

. In your HR resource, go to icon:info[] *Details*.
. Disable the *Create*, *Update*, and *Delete* capabilites.
	** You can disable Create and Delete by clicking their respective buttons.
		As for the Update capability, you need to select *Enabled*: _False_ in the modal that appears after clicking the capability button.

image::../hris-resource-capabilities.webp[title="Resource capabilities screen with the Create, Update, and Delete capabilities highlighted and disabled as per the instructions above"]

=== Import Users From the HR System

// This is covered in [First Steps With MidPoint: Assessment - Evolveum Docs](https://docs.evolveum.com/midpoint/methodology/first-steps/assessment/) but we need this for GUI

Everything is now ready for import.
Before you proceed with the real import, it's best to _simulate_ the action first and see if everything behaves as expected.

==== Simulate First

. You first simulate importing one account.
    Refer to the xref:/midpoint/reference/tasks/synchronization-tasks/import-and-reconciliation/gui/#simulate-import-of-a-single-object[guide on import preview] for details.
. Then, try it with all accounts.
    ** Refer to the xref:/midpoint/reference/tasks/synchronization-tasks/import-and-reconciliation/gui/[guide on creating tasks in GUI].
	** Select icon:upload[] btn:[Import task] and switch on the *Simulate task* toggle to activate simulation mode.
    ** Use _Preview_ mode with the _Development_ configuration in the xref:/midpoint/reference/tasks/synchronization-tasks/import-and-reconciliation/gui#execution[execution setup screen].
    ** xref:/midpoint/reference/tasks/synchronization-tasks/import-and-reconciliation/gui/#read-simulation-results[Inspect the simulation results] and rectify the resource configuration if needed.
	** You may notice a discrepancy between the number of your resource objects and the number of to-be imported people.
		That's expected if link:#mapping-script[your mapping sets some people as inactive].
. Finally, after you get expected results during the simulation,
	set up a *new import task* using the same steps as above. +
	Now, however, with the *simulation toggle switched off* to run the actual real import.

Refer to xref:/midpoint/reference/admin-gui/simulations/[] for guidance on interpreting simulation results.

[TIP]
====
We strongly suggest you *don't skip the simulation steps*.
It's the best way to make sure your resource configuration behaves as expected and fix it if needed.
====

==== Import for Real

Once you confirm you get the expected results during the simulations, you can *import the users for real*:

. Make sure you have all relevant objects in the _Active_ lifecycle state:
    ** The whole resource
    ** The object type for accounts
    ** Mapping rules
    ** Synchronization rules
	** You can use the icon:heart-pulse[] btn:[Check detailed lifecycle] button in the top menu within the resource to view a list of individual resource components and their current lifecycle states.
. Create the same import task you used for simulation but this time with the *simulation toggle switched off*, i.e., use the _Undefined_ execution mode with _Production_ configuration.
    ** With the *Simulate task* toggle off, you won't see the *Execution* screen and midPoint uses the production settings automatically.
. Check the imported accounts in the icon:male[] Accounts section of your resource.
. You can find all imported users also under icon:user[role="red"] *Users* > icon:user[] *Persons*.

image::../hris-people-imported.webp[title="List of focus objects with the Person archetype"]

If you see a list similar to the one above―congratulations, you've imported your users to midPoint and you're ready to connect a target system to midPoint.

You may ask if it's OK to have employee numbers as names of users instead of their real names.
Good and timely question.
It's up to you, but generally, it's better to use usernames as use object identifiers (names).
In this guide, we're going to use the LDAP resource covered in the next sections as a source for usernames because, unlike the HR system, the LDAP resource contains the usernames.

== Connect Your LDAP Target System

The next thing to do is to connect your target system to midPoint.
A target system is a resource that acts as a recipient of data _from_ midPoint.
It's not authoritative, yet it has data on the same accounts that you've imported _to_ midPoint from the HR system.

When a system isn't authoritative, it means that it can't overwrite data in midPoint.
Moreover, midPoint is supposed to overwrite (read: rectify) the data on the resource if they happen to mismatch the data in midPoint.
This is useful in cases when someone creates an unauthorized ("illegal") account on the target system, for example.
Such an account needs to be deleted and midPoint does so as soon as it finds it, if instructed so.

As mentioned in the previous chapter, the target system in this guide is an LDAP server.

.No coin is one-sided
[TIP]
====
Target systems may not be authoritative in general,
yet they sometimes contain data we don't have in other systems and need to pull them _into_ midPoint
rather than delete them from the resource as superfluous.

In the case of this guide, it's be the situation with usernames.
We'll read the usernames from the otherwise write-only non-authoritative LDAP system.
More on that in the sections about mappings and correlation rules.
====

=== Create a Resource for the LDAP System

The steps you're to take to connect the target system are very similar to what you did with the HR source system.

*Use the xref:/midpoint/reference/admin-gui/resource-wizard/create-resource-using-wizard/[guide on connecting a resource to midPoint] to help you with the configuration.*

. Create a resource from scratch.
. Use the xref:/connectors/connectors/com.evolveum.polygon.connector.ldap.LdapConnector/[LDAP connector].
. Name the resource descriptively, such as _LDAP with users_.
. Configure connection to the LDAP server.
    ** The connector configuration is more complex.
       If you're unsure, your LDAP server admins can help you fill in the right values.
       The xref:/connectors/connectors/com.evolveum.polygon.connector.ldap.LdapConnector/#resource-examples[LDAP resource examples] may also help.
. Create the resource in the _Proposed_ lifecycle state.

[TIP]
====
If you want to follow this guide for learning purposes but don't have an LDAP system at hand, you can imitate it using a CSV resource instead.

To imitate the LDAP resource used in this guide and achieve similar situations, use the this link:../ldap-users-sample.csv[CSV file exported from our training LDAP server].
In such a case, you'd use a CSV connector and an object type of the _AccountObjectClass_ class instead, but the rest of the configuration would stay largely the same.
====

=== Configure the LDAP Resource Object Type

Similarly to the HR system, the LDAP needs a resource object type for the accounts stored on it as well.

*Use this guide for xref:/midpoint/reference/admin-gui/resource-wizard/object-type/[instructions on object type configuration].*

. Name the object type _Normal Account_, for example.
. The type will be of the _Account_ kind, _default_ (or empty) intent, and with the _Default_ attribute set to _True_.
. Set *object class* to _inetOrgPerson_.
. On the data specification screen, set *Type* to _User_ and leave the *Archetype* empty.
. Keep the rest of the settings to defaults.

After you save your object type, you can preview the resource data to see what you're getting from the resource.

=== Define Synchronization Rules

Define the synchronization rules for the LDAP resource.
Use the _Proposed_ lifecycle state to prevent any damage to real data before you validate the configuration.

[cols="2,1,1,1,4"]
|====
| Name | Situation | Reaction | Lifecycle state | Comments

| link-unlinked
| Unlinked
| Link
| Proposed
| There's a focus for the account but it's not linked to the shadow of the account yet, let's link it.
	This isn't used during the first import, but it's necessary for later when the account shadows are in midPoint already.

| synchronize-linked
| Linked
| Synchronize
| Proposed
| Synchronize the data between the remote account and the focus based on mappings.

| synchronize-deleted
| Deleted
| Synchronize
| Proposed
| Restore "illegally" deleted accounts on the resource using the shadow in midPoint.

| delete-unmatched-resource-object
| Unmatched
| Delete resource object
| Draft
| Delete orphaned ("illegal") resource objects, i.e., those not present in HRIS and thus not having shadow in midPoint.
	Potentially destructive in case of misconfiguration. +
	Keep in _Draft_ (effectively disabled) until you learn later in the guide about options other than hard delete.

| create-correlation-case-for-disputed
| Disputed
| Create correlation case
| Proposed
| In case a candidate owner isn't found with 100% certainty, create a correlation case to let a human operator resolve the situation.
	You'll learn more a bit later.

|====

[TIP]
====
See xref:/midpoint/features/current/synchronization/[] to learn about the topic in more depth.
====

=== Create Inbound Mappings for Correlation

As the LDAP resource is currently strictly an inbound resource, meaning that _it can't push_ any data _to_ midPoint, you're going to define a new kind of mappings.
The thing is, to successfully correlate accounts on the LDAP server with the users in midPoint, you need _inbound_ mappings for the LDAP resource, i.e., _from_ LDAP _to_ midPoint.
However, as you don't want any data coming from LDAP to midPoint, the regular inbound mappings aren't the best fit.

That's why you're going to define inbound mappings _strictly for correlation_ purposes.
MidPoint will use these mapping rules only to know which resource attribute to correlate with which _internal_ (focus) user attribute.

These are the mappings to use:

[cols="2,1,1,1,1,5"]
|====
| Name | Source | Expression | Target | Lifecycle state | Comments

| inbound-employeeNumber-for-correlation
| `employeenumber`
| As is
| `personalNumber`
| Active
| Used for correlating employee number in the resource with the personal number in midPoint.

| inbound-surname-for-correlation
| `sn`
| As is
| `familyName`
| Active
| Used for the second correlation rule when the default employee number correlation fails.

| inbound-givenName-for-correlation
| `givenname`
| As is
| `givenName`
| Active
| Used for the second correlation.

| inbound-locality-for-correlation
| `l`
| As is
| `locality`
| Active
| Used for the second correlation.

|====

Refer to this guide on how to define mappings: xref:/midpoint/reference/admin-gui/resource-wizard/object-type/mapping/[].
Use *inbound mappings* and set them to be used for correlation only:

. Click icon:edit[] btn:[Edit] on the far-right on each mapping row.
. In *Use for*, select _Correlation_.
. Click icon:arrow-right-from-bracket[rotate=180] btn:[Exit wizard].

// TODO: task 12 - rework /midpoint/reference/master/admin-gui/resource-wizard/object-type/mapping/
// to be better structured and contain more info on advanced mapping settings,
// so that I can just link it from here instead of writing the whole guide on correlation-only setting.

=== Define LDAP correlation rules

Now is the time to define correlation rules for the LDAP resource accounts.

Correlation in midPoint is a mechanism used to identify the owner of a resource object, such as an account.
It involves finding the corresponding focus object associated with a particular resource object.
This process essentially binds the xref:/glossary/#shadow[shadows] of the resource objects to their appropriate midPoint xref:/glossary/#focus[focal objects].

Refer to xref:/midpoint/features/current/correlation/[] for more details on the topic.

In general, to correlate objects from various resources, you need to find a common identifier.
In the case of the showcase data this guide uses, the common identifier are the employee numbers.
If an LDAP server entry has the same employee number as a user in midPoint, they're surely a match.

For the cases when this bullet-proof matching fails due to erroneous data, for instance,
you can set up a fall-back correlation rule using a set of other attributes, such as first name + surname + locality.
Such rule doesn't have as high confidence because there may be cases when two people of the same name are in the same place.
For this lower confidence, this rule is set to create a correlation case,
meaning it can only suggest which focus object should be bound to which resource shadow, but a human operator needs to confirm the match.

In the suggested setup below, the fall-back rule that uses names+locality has the confidence of only 0.5.
That means that even if all the three attributes match, the match would be only 50% sure and, thus, a correlation case would be created by midPoint.

Refer to this guide on setting up correlation: xref:/midpoint/reference/admin-gui/resource-wizard/object-type/correlation/[].

Here are the correlation rules to use.

[cols="~,~,1,1,1,~"]
|====
| Rule name | Description | Weight | Tier | Enabled | xref:/midpoint/reference/admin-gui/resource-wizard/object-type/correlation/#set-up-correlators[Correlators] (Item : Search method)

| personalNumber-correlation
| Correlation using `personalNumber`. Doesn't require human intervention.
|
| 1
| True
| `personalNumber` : Exact match

| last-resort-correlation
| Correlation using givenName, familyName and locality. Trusted only by 50%, human intervention is needed.
| 0.5
| 10
| True
| `givenName` : Exact match +
    `familyName` : Exact match +
    `locality`: Exact match
|====

[NOTE]
====
The attributes used in the correlation rules are acquired by the correlation-only inbound mappings.
// TODO: Add link to the relevant section of the mapping GUIDe /admin-gui/resource-wizard/object-type/mapping/ when it's written
====

=== Simulate LDAP Reconciliation

To test your configuration, run a simulated reconciliation task on the development environment.

*Use this guide for xref:/midpoint/reference/tasks/synchronization-tasks/import-and-reconciliation/gui/[instructions on creating tasks].*

. In your LDAP target resource, create a *Reconciliation Task*.
. Switch on the simulation toggle to first preview the changes and prevent any harm to your data.
. Name the task, e.g., _Reconciliation with LDAP - development simulation_.
. On the *Execution* screen, select the *preview mode* with *development configuration*.
. After you configure and create the simulated reconciliation task,
	run it and xref:/midpoint/reference/tasks/synchronization-tasks/import-and-reconciliation/gui/#read-simulation-results[inspect the simulation results] to see how your mapping and synchronization rules work.

When reviewing the simulation results in icon:chart-line[] *Operational statistics*, you should get a result similar to the examples below.

The content of the table depends on the data in your systems as well as your actual configuration and marks applied.
When you run the reconciliation for the first time on the resource, the original state is always _No record_.

If you use the sample data provided in this guide, these are the numbers you would get on the first CSV-simulated LDAP reconciliation simulation:

.Synchronization situation transitions
[cols="8*"]
|====
| Original state  | Synchronization start  | Synchronization end  | Exclusion reason  | Succeeded  | Failed  | Skipped  | Total
| No record       | Unlinked               | Linked               |                   | 47         | 0       | 0        | 47
| No record       | Disputed               | Disputed             |                   | 3          | 0       | 0        | 5
| No record       | Unmatched              | Unmatched            |                   | 5          | 0       | 0        | 7
|====

Should you run the task again without any changes to resource data or object marks (we will get to those shortly), the original state would match the synchronization start now:

.Synchronization situation transitions
[cols="8*"]
|====
| Original state  | Synchronization start  | Synchronization end  | Exclusion reason  | Succeeded  | Failed  | Skipped  | Total
| Unlinked        | Unlinked               | Linked               |                   | 47         | 0       | 0        | 47
| Disputed        | Disputed               | Disputed             |                   | 3          | 0       | 0        | 3
| Unmatched       | Unmatched              | Unmatched            |                   | 5          | 0       | 0        | 5
|====


// Image not needed thanks to the tables, I think @dakle 2025-10-16
// image::../ldap-correlation-simulation-result-operational-statistics.webp[title="Operational statistics of the simulated LDAP reconciliation task"]

The numbers in the above examples say the following:

* 48 accounts that were found on the resource are unlinked and would be linked.
* 2 accounts that were found cannot be correlated reliably, so they are disputed and correlation case would be created.
* 4 accounts that were found would stay unmatched because no focus object was found for them.
	According to the synchronization rules we set before, these accounts would be deleted from the LDAP resource.

The correlation was simulated so none of the synchronization end situations actually happened.

=== Mark Unmatched Accounts to Prevent Deletion

In case your target LDAP resource contains accounts that cannot be correlated with the focal objects you have in midPoint from the source HR system,
you can mark some of them to protect them from being prematurely deleted.
This is useful if you are not sure about the exact purpose of some service accounts, for example,
or need to further investigate as to why an account can't be correlated.

Refer to xref:/midpoint/reference/concepts/mark/[] and xref:/midpoint/reference/admin-gui/resource-wizard/object-type/policies/#mark_manually[marking object in GUI] for details on using object marks.

Here's the marking strategy you can use:

* If you know a certain account is valid and present in HR but can't be correlated due to some error in data, mark it as _Correlate later_.
* If you need to preserve an account that's not in HR but is valid, such as service accounts, protect it using the _Protected_ mark.
* If you're not sure why an account unknown to HR exists, mark it as _Do not touch_ so that it does not get deleted and you can investigate and decide their fate later.
* If you discover LDAP accounts that should not be there at all, like legacy or obviously malicious accounts, don't mark them anyhow.
	They will get deleted as per the synchronization rules.

Be careful if your HR system doesn’t contain or export former employees data.
In such situation, you would not have the former employees in midPoint and their AD/LDAP accounts would appear as orphaned.

[TIP]
====
The point here is that you can move on with your deployment even if there are inconsistencies and unknowns in your data.

Mark these points of data and leave them for later as per the xref:../#the-concept-of-an-iterative-cyclic-approach[iterative approach].
This way you get tangible results soon without having to wait for a solution to every obstacle.
====

image::ldap-marked-accounts.webp[]

Now, if you run the simulated correlation task again,
you'd see a new entry in the operational statistics of the task telling you how many accounts there are with _No record_ and what's their _Exclusion reason_ (you marked them to avoid their deletion).
The one remaining _Unmatched_ account is the hacker account that needs to be deleted as soon as possible.

[cols="8*""]
.Synchronization situation transitions
|====
| Original state  | Synchronization start  | Synchronization end  | Exclusion reason  | Succeeded  | Failed  | Skipped  | Total
| Unlinked        | Unlinked               | Linked               |                   | 47         | 0       | 0        | 47
| Disputed        | Disputed               | Disputed             |                   | 3          | 0       | 0        | 3
| Unmatched       | No record              | No record            | Protected         | 0          | 0       | 4        | 4
| Unmatched       | Unmatched              | Unmatched            |                   | 1          | 0       | 0        | 1
|====

// https://youtu.be/GIlr7xYi8UI?t=326
// TODO: improve the object marking GUIde (#86)

=== Check the Simulated Results Using Filters in the Account List

Aside viewing the task simulation results, you can use another way to confirm your setup behaves as expect.
You can view the LDAP accounts and their *Situations*.
Even when you simulate reconciliation, the situations of the resource accounts reflect the results of the simulation, i.e., midPoint knows which accounts would be _matched_, _disputed_, etc., and updates the account situations accordingly.

. Under the LDAP resource, go to *icon:male[] Accounts*.
. Use the *Situation* filter above the account list to see accounts in various states:
	** Select _Unlinked_ to see accounts that would be linked, i.e., their respective focal object (owner) can be determined automatically under the current configuration.
	** Select _Unmatched_ to see accounts that can't be matched to their respective focal objects. +
		Some of them are marked by you as protected or for later correlation.
		Unmatched accounts that are not marked will be deleted if you have the xref:#define-synchronization-rules[synchronization rule for that] (action _Delete resource object_ for the _Unmatched_ situation)
	** Select _Disputed_ to see accounts that can't be matched with 100% certainty to their respective focal objects. +
		You'll get a correlation case to resolve these after you run real production correlation task. +
		In the sample data used in this guide, the disputed account would be Anna Lopez who has a wrong `empnum` in HRIS and has to be correlated using `givenName`, `familyName`, and `locality` as such.
. Click icon:search[] btn:[Basic] to confirm the selected search criterion.

In the list, if you see, for example, accounts that are _unmatched_ and not marked but you are not sure whether it's safe to have them deleted, xref:#mark-unmatched-accounts-to-prevent-deletion[mark them] now.
You can investigate later.

image::../ldap-accounts-disputed-after-simulation.webp[title="List filtered to show only disputed LDAP resource accounts"]

== Reconcile Your LDAP Accounts

Once you confirm via running simulated reconciliation tasks that your LDAP configuration works as expected
and no accounts you need to preserve are about to be deleted, you can run the _real_ reconciliation between HRIS and LDAP.

Firstly, *switch all the configurations under your LDAP resource to _Active_* with the exception of _delete-unmatched-resource-object_.
Keep that one in _Draft_ until you learn how to disable accounts instead of delete first.

[TIP]
====
Use the icon:heart-pulse[] btn:[Check detailed lifecycle] button in the top menu within the resource to view a list of individual resource components and their current lifecycle states.
====

Then, do the one last simulation, this time on production configuration:

. Create a xref:/midpoint/reference/tasks/synchronization-tasks/import-and-reconciliation/gui/[new reconciliation task] for the LDAP resource.
. Switch on the simulation toggle to first preview the changes and prevent any harm to your data.
. Name the task, e.g., _Reconciliation with LDAP - production simulation_.
. On the *Execution* screen, select the *preview mode* with *production configuration*.
. After you configure and create the simulated reconciliation task,
	run it and xref:/midpoint/reference/tasks/synchronization-tasks/import-and-reconciliation/gui/#read-simulation-results[inspect the simulation results] to see how your mapping and synchronization rules work.

The operational statistics numbers should be the same as when you ran the task in the simulated development configuration.

At last, if everything in the results shows as expected,
create yet another reconciliation task―this time with the simulation toggle switched off―and *run the reconciliation for real*.

The expected result of running the reconciliation on production is that:

* MidPoint creates correlation cases for accounts it cannot reconcile with 100% certainty (e.g., when `empnum` differs in HRIS and LDAP).
* All accounts that match "cleanly" between HRIS and LDAP are linked and their focal objects have two projections now.
* The accounts you need to get rid of (e.g., the hacker account in our data) are not yet deleted from the LDAP system because the synchronization rule is in _Draft_ state still.

== Resolve correlation Cases

If any of the LDAP accounts fail to reconcile with 100% certainty and
midPoint falls back to the xref:#define-ldap-correlation-rules[_last-resort-correlation_ correlation rule],
the production correlation task (as per the xref:#define-synchronization-rules[synchronization rules]) creates a correlation case for a human operator to resolve.

A correlation case is the way for you to efficiently find an owner for disputed accounts particularly thanks to the suggested supposed owners you can select from.

You can find all active correlation cases under icon:case_thick[] *Cases*.

If you use the sample CSV data provided in this guide, you would see this list of correlation cases:

.List of correlation cases in midPoint. _CSV LDAP simulation_ is the LDAP resource simulated by using the CSV file provided in this guide.
[cols="9*"]
|====
| Name                                                        | Description  | Object               | Actors                                  | Opened | Closed | Outcome  | State | Workitems
| Correlation of account 'geena' on CSV LDAP simulation       |              | CSV LDAP simulation  | midPoint Administrator (administrator)  |        |        |          | open  | 1
| Correlation of account 'bcarpenter' on CSV LDAP simulation  |              | CSV LDAP simulation  | midPoint Administrator (administrator)  |        |        |          | open  | 1
| Correlation of account 'alopez' on CSV LDAP simulation      |              | CSV LDAP simulation  | midPoint Administrator (administrator)  |        |        |          | open  | 1
|====

When you click a case to open it for an inspection:

* icon:circle[] *Basic* shows details about the particular case.
* icon:circle[] *Correlation* lets you know how closely the resource object shadow and its suggested focal object matches.
* icon:circle[] *Workitems* is the workbench to resolve the correlation case.

Check the suggested resource object shadow owners on the icon:circle[] *Workitems* screen.
If any of them is the right one, click the the btn:[Correlate] button in the particular candidate column.
In case no suitable owner exists in the database, there is also an option to btn:[Create new] focal object in midPoint.
That's not, however, recommended for cases with an authoritative 3rd-party system like the HR system herein.

image::../ldap-hris-correlation-case-workitem-resolution.webp[title="Workitems screen in the correlation section of midPoint, showing a suggested resource object shadow owner candidate"]

If you're using our sample data to follow this guide, you have one correlation case to resolve after the production reconciliation task finishes, and that's Anna Lopez who has a wrong _empnum_ in the HR system.

== Import Usernames From LDAP

When setting up the HR resource, you used _empnum_ for account names in midPoint
because the HR system does not have any better unique identifier.

Now, however, you have the LDAP resource connected and with that, you gave midPoint access to much more human friendly usernames that are stored in the LDAP system.
It is a good time now to adjust the HR and LDAP resource mappings so that account owner focal objects are named using the LDAP usernames.

Here's the outline of what you're going to do to achieve that:

. Set the _name_ attribute mapping strength in the HR resource to to _weak_.
. Create an inbound mapping for _name_ in the LDAP resource with an appropriate source attribute containing the usernames.
. Run a simulated reconciliation task to validate the new setup.
	** First, test it on a single account.
	** Then, simulate it on all accounts.
. Reconcile the accounts again for real.

=== Adjust the Mappings to Prepare for Username Import From LDAP

Firstly, adjust the HR resource _name_ mapping:

. In your HR resource, open inbound mapping settings.
. Locate the mapping populating the _name_ attribute with the value of the source _empnum_ attribute. +
	In this guide, it is called _empnum-to-name_.
. In advanced settings of the mapping, change its *strength* to _weak_.

Secondly, add a new inbound mapping for the _name_ attribute in the LDAP resource:

. Look into your LDAP data and locate the name of the attribute that holds usernames. They have to be unique across all accounts. +
	In the sample data used in this guide, the name of the attribute is _uid_.
. In your LDAP resource, open inbound mapping settings.
. Add a new mapping according to the table below. +
	Adjust the mapping name and the source attribute name according to your data.

[cols="6*"]
.Strong inbound mapping to copy _uid_ parameter with usernames to _name_ parameter
|====
| Name                         | Source | Expression | Target | Lifecycle state | Comments
| inbound-uid-username-to-name | uid    | As is      | name   | Proposed        | Set the mapping *Strength* to _Strong_ and leave the *Use for* as _Undefined_.
|====

=== Test the Configuration Update

Before you make the leap, test the new configuration using a simulated import.
Firstly, on a single user using the _Simulated development_ execution mode, then on the whole set of accounts.

When you view the results of the simulation, you should see the _focus object renamed_ notice.

image::../ldap-import-usename-simulation-focus-renamed.webp[title="A single user import preview simulation result showing that the username would have been imported successfully and the focus object would have been renamed"]

After the single user import preview, run the simulated development reconciliation task you already have under *icon:tasks[] Defined tasks* from the previous reconciliations.
Inspect the results, you should see, among other things, that the focus objects would be renamed according to the LDAP username inbound mapping.

Once you confirm the simulation yields expected results, run the real production reconciliation task which you used to reconcile the LDAP accounts previously.

[NOTE]
====
No incorrect data in your target system will be fixed yet.
So far, you've correlated (as in connected) the identities across your source and target systems.
That's not the end of the story, though: you'll see how to automatically fix incorrect data soon.
====

== Provision Accounts to Target Systems

. Create outbound mappings for the target system (module 7, 7:30)
i   .. simulate first
. Activation - veci jako deactivate instead of delete a delayed delete
. Credentials - poskytuje hesla do LDAP

At this point, you have the identities in your systems mostly correlated.
Up until now, when your HR created, updated, or deactivated a user in the HR information system (HRIS),
someone also had to go and do the same to that user in the target LDAP system.

The logical next step now is to automate the process.
That means to automatically:

* Create account in LDAP based on the data in HRIS.
    ** Create the first password for the new user in LDAP.
* Update accounts in LDAP according to changes that happen in HRIS.
* Suspend and possibly delete accounts for users suspended in or deleted from HRIS.

There are several tools in midPoint you are going to use for these tasks: outbound activation, outbound credentials, and outbound mappings.
When you are done with this setup, it is no longer necessary to manually update user accounts in the target system:
you do the change once in the authoritative HR system and midPoint propagates it automatically to all configured target systems.

=== Create outbound mapping rules for LDAP

Firstly, to enable provisioning to the LDAP target system, you need outbound mapping rules.
Outbound mapping rules work the same as inbound mappings, they merely map the data the other way round: _from_ midPoint _to_ the target system.

* Refer to this guide on creating mapping rules: xref:/midpoint/reference/admin-gui/resource-wizard/object-type/mapping/#outbound_mappings[]
* Use outbound mappings because you’re pushing attributes _to_ the resource _from_ midPoint.
* The list of rules below is for illustration purposes.
    The actual attributes you need to map depend on your target system.

[cols="2,1,1,1,1,4"]
.LDAP outbound mapping rules
|====
| Name                              | Source             | Expression | Target           | Lifecycle state | Comments
| name-fullName-to-dn               | `name`, `fullName` | Script     | `dn`             | Proposed        | Create a distinguished name out of name and full name using a script. +
    Find the script to use beneath the table.
| name-fullName-to-cn-weak          | `name`, `fullName` | Script     | `cn`             | Proposed        | Create LDAP common name out of name and full name. +
    Use a weak mapping strength to avoid overwriting existing values. +
    See xref:/midpoint/reference/admin-gui/resource-wizard/object-type/mapping/advanced-mappings/[how to set a mapping strength]. +
    Find the script to use beneath the table.
| fullName-to-displayName           | `fullName`         | As is      | `displayName`    | Proposed        |
| givenName-to-givenName            | `givenName`        | As is      | `givenName`      | Proposed        |
| familyName-to-sn                  | `familyName`       | As is      | `sn`             | Proposed        | Copy family name to surname.
| name-to-uid                       | `name`             | As is      | `uid`            | Proposed        | User identifier based on `name`.
| locality-to-l                     | `locality`         | As is      | `l`              | Proposed        |
| personalNumber-to-employeeNubmber | `personalNumber`   | As is      | `employeeNumber` | Proposed        |
|====
// TODO: why is the name-fullName-to-cn-weak set as weak? @dakle 2025-06-18

.name-fullName-to-dn script
[source,groovy]
----
def cn
if (iteration == 0) {
    cn = fullName
} else {
    cn = fullName + ' (' + name + ')'
}
return basic.composeDnWithSuffix('cn', cn,
    'ou=users,' + basic.getResourceIcfConfigurationPropertyValue(resource, 'baseContext')
)
----

.name-fullName-to-cn-weak script
[source,groovy]
----
def cn
if (iteration == 0) {
    cn = fullName
} else {
    cn = fullName + ' (' + name + ')'
}
return cn
----

If you are "faking" the LDAP resource using a CSV file loaded via the CSV connector, you need to use the following script for the DN construction instead.
This is because the built-in `getResourceIcfConfigurationPropertyValue` method works for LDAP resources, but not for CSV resources.

.name-fullName-to-dn script (CSV version)
[source,groovy]
----
def cn
def fn
if (iteration == 0) {
    fn = fullName
} else {
    fn = fullName + ' (' + name + ')'
}
cn = 'cn=' + fn + ',ou=users,dc=example,dc=com'
return cn
----

=== Activate users in the target system

Activation in midPoint is the state of an object, such as user, account, or entitlement.
Activation is based on several properties, namely _administrative status_, _valid from_, _valid to_, and _lifecycle status_.
Based on the values of these object attributes, midPoint computes an xref:/midpoint/reference/concepts/activation/#effective-status[*effective status*].

We can use effective status in *outbound activation mapping* to _activate_ or _deactivate_ accounts on resources, such as an LDAP system.

Refer to xref:/midpoint/reference/concepts/activation/[] for the full documentation activation.

*Refer to xref:/midpoint/reference/admin-gui/resource-wizard/object-type/activation/[instructions on working with activation in the midPoint GUI]*.

In total, create *three activation outbound mappings*:

* icon:id-card-clip[] *Administrative status*
    ** *Lifecycle state*: _Proposed_
    ** *Name*: _account-status-based-on-mp-user_, for example.
    ** *Strength*: _Strong_
    ** You can leave *Source* empty because midPoint already knows the default source for this mapping (effective status).
    ** The activation mapping controls the account status in the target system based on the effective status of the respective focal object in midPoint.
* icon:user-slash[] *Disable instead of delete*
    ** *Lifecycle state*: _Proposed_
    ** This ensures that illegal accounts don't get deleted but rather disabled.
        It's best to use this in conjunction with the Delayed delete configuration.
* icon:clock[] *Delayed delete*
    ** *Lifecycle state*: _Proposed_
    ** Set *Delete after* to a value appropriate to your use case.
    ** Accounts marked for deletion will deleted no sooner than after the grace period set here elapses.
        *** For testing, sensible values are in minutes.
        *** For production, sensible values are likely weeks or months.

image::../ldap-outbound-activation-mappings.webp[Outbound activation mappings for a target resource]

activation explanation: explanatory video, module 7, 5:30

=== Create initial passwords in the target system

When you provision accounts to target systems, you need to take care of users' initial passwords.
There may be at least two reasons:

* Some systems refuse to create a user with a blank password.
* Without a password, the new user would either be unable to log in at all,
    or the system would let them in without a password.
    Neither of which is likely a behavior you want.

That means midPoint needs to supply an initial password for new accounts.
It's up to the app using the target system to require a password change upon the first login.

Moreover, you may let your users change their password directly in midPoint.
In such a case, you need to tell midPoint to propagate the changed password to the target system.

*Refer to xref:/midpoint/reference/admin-gui/resource-wizard/object-type/credentials/[instructions on working with credentials in the midPoint GUI]*.

For the purposes of the setup we're building in this guide, you are going to use two outbound mappings for credentials:

* Generate an initial password for new accounts.
    ** *Lifecycle state*: _Proposed_
    ** *Name*: _initial-passwd-generate_, for example.
    ** *Stregth*: _Weak_
    ** *Expression*: _Generate_
    ** This mapping needs to be _weak_ so that it doesn't overwrite any existing password. +
        Weak mapping is used only when the target attribute has no value.
* Copy password from midPoint to the resource in case a user changes the password in midPoint.
    ** *Lifecycle state*: _Proposed_
    ** *Name*: _passwd-change_, for example.
    ** *Stregth*: _Normal_
    ** *Expression*: _As is_
    ** If your users are not expected to ever use midPoint to change their passwords, you don't need this mapping.

Refer to these resources for more information on credentials:

* xref:/midpoint/reference/security/credentials/[]
* xref:/midpoint/reference/resources/resource-configuration/schema-handling/credentials/[]
* xref:/midpoint/reference/security/credentials/password-policy/[]

explanation: explanatory video, module 7, 10:47

=== Simulate provisioning

As always, before you put the new settings to production, simulate first to see if you get expected results.
If you followed this Methodology from the start, you already have a xref:/midpoint/methodology/first-steps/connect/#reconcile-your-ldap-accounts[task for a simulated reconciliation] ready.
If not, create it according to the linked guidance.

After you run the simulated reconciliation, check the simulation results.
You may see some accounts are renamed on either side as midPoint is trying to fix the data and make them consistent.

If some results are not as expected, adjust the resource configurations as needed.
You can run the simulation over and over again safely, it doesn't touch your data.

=== Put the LDAP Provisioning into Production

Having inspected and verified the results of the simulation,
it is turn them into reality.

For that to happen, you need to move all the mappings (the "regular" ones, as well as those for activation, and credentials) from the _Proposed_ lifecycle state to _Active_.

After that, run the production reconciliation task in the LDAP resource.

You have turned on configuration for provisioning to the target LDAP resource for all attributes, as well as activation and passwords.
You don't have yet set up an automatic synchronization between the source and target resources, that is, the HR and LDAP.
However, your configuration is almost ready for that and we'll get to that very soon.

explanation in explanatory video, module 7: 18:16

== Automate the processes

After the steps you've done up to now, your LDAP and HR data can be considered reasonably clean and in sync.
With that, you can *move on to automating the setup* so that it works autonomously:

* Periodically check the HR system and import new accounts, if any.
* Regularly check the LDAP system and clean up (delete) any illicit accounts.
* Provision LDAP accounts for new employees imported from HR.
* Create passwords for new HR accounts when provisioned to LDAP.

=== Generate Usernames in MidPoint

Up until now, we've used the employee number from the HR system and the UID attribute from the LDAP system for user names.

Now, it's time to configure midPoint to let it create usernames on its own so that it can provide LDAP accounts to new users created in in the HR system.
That's because if a new person joins the organization, they don't have an LDAP account, meaning there's nowhere to take their username from.

For midPoint to be an authoritative source of new usernames, you need to take a couple of steps:

* Disable the HR inbound mapping _empnum-to-name_ which takes the `empnum` attribute and uses it for the focus `name` attribute.
* Disable the LDAP inbound mapping _inbound-uid-username-to-name_ which takes the `uid` attribute and uses it for the focus `name` attribute.
* Activate the _Person object template_ that can generate usernames based on the focal object name and surname.

==== Disable the obsolete inbound mappings for name

. For the *HR resource*:
    .. In the HR resource, go to xref:/midpoint/reference/admin-gui/resource-wizard/object-type/mapping/[mapping configuration].
    .. In *Inbound mappings*, set the _empnum-to-name_ mapping to the _Archived_ lifecycle state
    .. Save the configuration.

. For the *LDAP resource*:
    .. In the LDAP resource, go to xref:/midpoint/reference/admin-gui/resource-wizard/object-type/mapping/[mapping configuration].
    .. In *Inbound mappings*, set the _inbound-uid-username-to-name_ mapping to the _Archived_ lifecycle state
    .. Save the configuration.

==== Activate the Person object template mapping for usernames



- enable mapping in object template
    - object template in MP is an object that allows running mappings whenever a focal object based on the template is created (e.g., user)
    - can be either global (for specific focus type, e.g., user), or archetype-specific (e.g., for Person)
        - there's a built-in object template for the Person archetype in MP - contains 2 default mappings - generate-fullname and generate-name-jsmith-8-2 (with iterator)
            - this Person object template is tied to the Person archetype which is used for everybody we import from the HR system.
            - various users can have various archetypes which can induce different behavior
        - the username generator jsmith is weak so it only generates the value when the attribute is empty and doesn't change it when the person changes their name (e.g., when married)
        - object template mappings work only with focal objects, they have focal object attributes on both sides
        - if you want to enforce the values, make the mappings strong (e.g., full name)
- disable HR inbound mapping for name
- disable LDAP inbound mapping for name - LDAP is no more the source system for us

- to automate sync with HR, we need a reconciliation task that is set to run repeatedly in given intervals (minutes, hours, ... can also be cron-ed); otherwise the task is the same
- to automate LDAP account creation, we need to make MP create them
    - important to understand concepts of assignment and inducements:
        - assignment is a policy, a decision that an object (e.g., user) should have something (e.g., a role)
        - inducement is an indirect assignment - object (inducement) assigned to a user causes the user to have something (e.g. a role or account)
        - rule of thumb: users have assignments (roles, orgs, services, accounts, archetypes, ..); roles, orgs, services, accounts, archetypes have inducements - they cause something to happen to users who have them assigned (access rights, accounts, ...)
    - archetype can be considered a birth right and we'll add LDAP provisioning to the Person archetype - resource account construction inducement in the Person archetype
        - video: module 8: 22:45
        - video 25:10 - mappings in the archetype which we won't use, but may be worth mentioning?
- Entitlements and associations
    - accounts are resource objects representing resource accounts
        - entitlement - resource object representing resource privelage, e.g., AD group
        - entitlements can be associated with accounts ==> membership
        - provisioning manages entitlements, i.e., provisioning translates association into account--entitlement relation
        - entitlements are resource objects like accounts with their own kind and intent
    - associations are configured in resource account object type (can be predefined in object template)
    - two possible ways for associations (28:58):
        - roles are pointing to users (objectToSubject)
        - users pointing to roles (subjectToObject)
    - midPoint doesn't store role memberships, it fetches the info on demand - searches all the groups for a user DN, for example.
        - Q: does that apply to 4.9+ as well? (with all the caching and such)
    - lifecycle states:
        - long-term leaves - account is suspended in MP -> disabled in LDAP
        - former employees - account is archived in MP -> deleted in LDAP -- but with disabled instead of delete + delayed delete

how delayed delete works
    - MP creates a trigger when the account is supposed to be deleted, is stored in account shadow
    - MP recalculates the account and deletes
    - trigger scanner scans timestamps and triggers the actions (usually runs in 5 minutes intervals ??? - what if the delay is only 2 minutes?)

- assignments and inducements enforce policies - if an object (e.g., user) should have something, e.g., a role, MP ensures that; creates the resource account and populates it with the right data, manages attributes of groups etc.
    - strong mappings ensure that MP enforces the correct values even if someone changes them in the target system - MP is authoritative

- during the migration to MP, MP can be set to tolerate group membership changes by external (legacy) systems; after the migration is done, MP can be set as intolerant
- when you turn on the automatic provisioning to AD via MP, don't forget to turn off provisioning to LDAP via legacy systems
- validity check scanner - runs each 15 minutes and checks validFrom and validTo to compute effective state (not used in this training)
- shadow refresh task (basically simplified reconciliation) - if MP has some changes cached in shadow objects which it couldn't have pushed previously to resource because it was down, for example, shadow refresh task triggers maintenance operations to push these changes to resource; also cleans up dead shadows after their retention period (by default 7 days)
    - dead shadow: when account is deleted on target system but shadow exists in MP. All the associations still exist, account can be recreated based on the dead shadow.


username generator logic explained in module 8 training video on 0:10:00

---
= The old original content follows
---

.Goal
TIP: Asses the _real_ data quality, determine practical next steps.
At this point we know what we _really_ have, what we can build on, what needs to be improved.
We can identify the most severe security risks, such as orphaned accounts.
Now we can improve our plan, adding more details based on the _real_ data.

You have some kind of HR data now.
In theory, you should use the HR data to create and manage accounts in target system, such as your Active Directory.
However, in practice, this is not entirely straightforward.

Firstly, it is almost certain that there are errors and inaccuracies in the HR data.
The data were maintained manually for a long time, with no way for automatic validation.
Mistakes in the data might be buried deep, surviving undetected for decades.
Having nothing to compare the data with, there is no telling how good or bad the data are.

Secondly, the data in your target systems (especially Active Directory) certainly leave a lot to be desired.
These were managed manually for years, with no automatic way to make sure they’re correct.
There will be account belonging to people that left your organizations years ago.
There will be accounts using maiden names of women that are married now.
There will be strange accounts and identifiers that originated ages ago when your organization was still small and system administration was fun.
There may be all kinds of weirdness and historical baggage frozen in time because nobody remembers what it does and everybody is scared to touch it.

In general, when deploying identity management system to an existing environment, we need to take extra care of the following:

. *usernames*: midPoint usernames should be the same as for the principal authentication system. In this methodology, we assume that company's Active Directory or LDAP which will be connected as the first target system is used as the source of usernames.
. *accounts*: we shouldn’t harm any existing accounts in an unexpected way
. *passwords*: we shouldn’t alter (e.g. re-generate) any existing account password

Taking HR data and simply forcing them to Active Directory will never work.
We need much smarter approach.

// TODO: short summary of the process

This is what you have to do:

== Connect HR System

*Connect HR* data source to midPoint.
Set up your HR identity resource in midPoint, using CSV or DatabaseTable connector.

.Please refer to the following documentation:

* xref:/midpoint/reference/admin-gui/resource-wizard/[]

You can see this step in action in the First Steps Methodology webinar video:

video::suo775ym_PE[youtube,title="Step 2: Connect Source System (HR)",start="1216"]

Deal with just the very basic data items for now:

* Names (given name, family name)
* Employee number, student number or similar identifier
* Status (active, former employee, alumni, etc.) and/or validity date/time (based on contract etc.)

You can ignore other fields for now.
We can get back to them later.

The resource is created in `Proposed` lifecycle status by default.
Keep it that way at this stage.

We recommend to use resource capabilities to disable `Create`, `Update` and `Delete` operations on the resource.

Create a new object type for HR accounts to allow creation of users in midPoint with `Person` archetype assigned.

.Please refer to the following documentation:

* xref:/midpoint/reference/admin-gui/resource-wizard/#object-type-configuration[Resource wizard - part Object type configuration]

WARNING: Make sure you select the proper archetype before importing the users. Change of archetype is not supposed to be a straightforward process as archetypes are expected to work as object classes in the future.

Preview your HR records which will be imported to see if you want to import all of them, or you want to import only a subset of them using a classification filter (e.g. if you want to ignore non-IT personnel).
While the resource is in `Proposed` lifecycle state, you can redefine classification filters and reclassify your HR accounts as many times as you wish.

[#import-users-from-hr]
==  Import Users From HR To MidPoint

*Import users* to midPoint, using HR data.
For simplicity, use HR person identifier (e.g. employee number) as the midPoint username.
We will import the usernames from AD/LDAP later.

.Please refer to the following documentation:

* xref:/midpoint/reference/admin-gui/resource-wizard/#wizard-for-task-creation[Resource wizard - part Wizard for task creation]

You can see this step in action in the First Steps Methodology webinar video:

video::suo775ym_PE[youtube,title="Step 3: Import from HR",start="1541"]

//Select appropriate algorithm for midPoint username.
//You surely have some username convention (such as `jsmith`) in place.

Start with importing a single HR account with preview option to see how the user would be created in midPoint.
Then you can xref:/midpoint/reference/simulation/[simulate] the import of all HR accounts using a simulated import task running with _Development_ configuration to see how all the users would be created in midPoint.

You can continually improve your imported data by adding more attribute mappings.

When finished, switch the HR resource to `Active` lifecycle state.

.Please refer to the following documentation:

* xref:/midpoint/reference/admin-gui/resource-wizard/#how-to-use-lifecycle-state[Resource wizard - part How to use lifecycle state]

WARNING: Make sure you’ve selected the proper archetype for users before importing them. Change of archetype is not supposed to be a straightforward process as archetypes are expected to work as object classes in the future.

Now you can import the HR data, creating user objects in midPoint.
As we’re working with simple data for now, the import should go well.

.User lifecycle
[NOTE]
====
This is where user lifecycle management starts.

We need at least some basic framework for user lifecycle management at this point.

If we can identify inactive (former) HR persons, we can utilize this information when checking for accounts in target systems that shouldn’t be there (if we don’t import inactive users from HR, we will see their accounts in target systems as simply orphaned).
====

Instead of setting user's `administrativeStatus`, we recommend to set midPoint user's `lifecycleState` property based on HR data as either:

* active
* suspended (e.g. temporarily inactive employees - parental leave, long-term sickness etc.)
* archived (e.g. former employees)

.If you have imported users with incorrect archetype
[NOTE]
====
If you’ve managed to import users from source system with an incorrect archetype, please do the following:

. Delete all imported users from midPoint (make sure you don’t delete `administrator` user)
.. midPoint will attempt to delete the source accounts in HR as well, if you have disabled `Create`, `Update` and `Delete` operations in resource capabilities, errors will be displayed (this is expected)
. Re-configure HR resource to use a correct archetype for user creation.
. Re-run the import task from HR resource.
====

[#connect-active-directory]
== Connect Active Directory

*Set up your Active Directory (or LDAP) identity resource* in midPoint and keep it in `Proposed` lifecycle state.
Create Object type definition for AD accounts and keep it in `Proposed` lifecycle state as well.

.Please refer to the following documentation:

* xref:/midpoint/reference/admin-gui/resource-wizard/[]

TIP: You can see this step in action in https://youtu.be/suo775ym_PE?t=1898&si=In5OAmPHUM9p7YdW[Step 4: Connect Target System in the First Steps Methodology Webinar] video.

You can see this step in action in the First Steps Methodology webinar video:

video::suo775ym_PE[youtube,title="Step 4: Connect Target System",start="1898"]

Set up outbound mappings for the small data set that you’ve (given name, username and so on) and keep them in `Draft` lifecycle state (effectively disabled).

Configure correlation rules for AD accounts.

Configure synchronization configuration in `Proposed` lifecycle state.

We don’t want to change any data in Active Directory yet.

.Please refer to the following documentation:

* xref:/midpoint/reference/admin-gui/resource-wizard/#synchronization[Resource wizard - part Synchronization]
* xref:/midpoint/reference/admin-gui/resource-wizard/#correlation[Resource wizard - part Correlation]
* xref:/midpoint/reference/admin-gui/resource-wizard/#mappings[Resource wizard - part Mappings]

.Resource templates
[NOTE]
====
Resource templates can be prepared in advance.

Creating a new resource based on resource template instead of creating it from scratch can save your time as the basic configuration would be pre-defined, and you can enable/update it as necessary.
====

TIP: Please refer to our https://github.com/Evolveum/midpoint-samples/tree/master/samples/resources/ad-ldap/AD[Active Directory resource sample] for more information. This sample was tested with our First Steps Methodology.


==  Correlate Active Directory Accounts

*Correlate Active Directory accounts* with midPoint users.
If you have employee numbers (or similar unique attributes from HR) stored in your Active Directory, then use that for correlation.
As an alternative if no such data can be used or if data is unreliable, you may want to use several attributes for _approximate_ correlation such as names, locality, department etc.
Manual confirmation using midPoint correlation cases can be used to specify midPoint user who should own the Active Directory account if the match is ambiguous.

.Please refer to the following documentation:
* xref:/midpoint/reference/admin-gui/resource-wizard/#synchronization[Resource wizard - part Synchronization]
* xref:/midpoint/reference/admin-gui/resource-wizard/#correlation[Resource wizard - part Correlation]
* xref:/midpoint/reference/admin-gui/resource-wizard/#wizard-for-task-creation[Resource wizard - part Wizard for task creation]


You can see this step in action in the First Steps Methodology webinar video:

video::suo775ym_PE[youtube,title="Step 5: Target System Integration",start="2027"]


After configuring correlation and synchronization (while the resource, object type and synchronization configuration is in `Proposed` lifecycle state):

//Otherwise, use the generated midPoint usernames (e.g. `jsmith` convention) as the correlation identifier to match //(assumed) majority of the accounts to their corresponding owners in midPoint:

. Run the simulated _reconciliation_ task on AD resource using _Development_ configuration.
. Then have a look at the task and simulation results in midPoint GUI (interactively).

If you maintained your identifier assignment conventions reasonably well, most identities should correlate well.
MidPoint will show you correlation statistics for your accounts.

Of course, if the correlation is not able to use the personal/employee numbers, just users' names, there will be problems of `John Smith` and `Josh Smith` with their `jsmith` and `jsmith42` accounts.
Let's leave that for later.
For now just focus on correlating the bulk of users.

If you get 80-90% users to correlate well, you’re done here.

There will be also orphaned accounts (`Unmatched` synchronization situation).
Based on your resource configuration, midPoint may report they will be deactivated (but we’re still in `Proposed` lifecycle state - just simulating).

We will analyze the accounts here, but we will take final decision later in <<Clean Up The Accounts>> to not stop us from progressing.

TIP: You can analyze/clean up the data in several iterations.

The orphaned accounts generally fall into the following categories:

. *Obviously orphaned accounts*:
Review the list of orphaned accounts (the accounts in Active Directory not having an owner in midPoint which should mean they aren’t related to HR data on which midPoint data is based) one by one and make sure these aren’t_ system accounts (see the _System (service) accounts_ category).
+
Be careful if your HR system doesn’t contain/export former employees data; in such situation you will not have the former employees in midPoint as users and their Active Directory accounts will be also considered orphaned.
+
If you’re absolutely sure the accounts should be deactivated, you don’t need to mark them and leave them to their (later) fate.

. *Orphaned accounts of unclear origin*:
Review the list of orphaned accounts (the accounts in Active Directory not having an owner in midPoint which should mean they aren’t related to HR data on which midPoint data is based) one by one and make sure these aren’t_ system accounts (see the _System (service) accounts_ category).
+
xref:/midpoint/reference/concepts/mark/[_Mark_ the undesired ones as Decommission later] to be deactivated eventually (but not yet).

. *System (service) accounts*:
For all accounts that are crucial for Active Directory, we need a different decision.
+
xref:/midpoint/reference/concepts/mark/[_Mark_ the system accounts as Protected in midPoint] to keep track of them, but ignore them otherwise by midPoint.

. *Accounts unmatched because of data inconsistencies.*
Review the rest of accounts which haven’t been matched or decided in the previous steps.
This is the time to take care of the Smiths, Johnsons and Browns if no reasonably unique attribute could have been used for their correlation.
If possible, update your correlation configuration to use more attributes to find matching users (e.g. Given name, Family name, Location, ...).
+
You can also try to figure out which account belongs to which user and correlate them manually.
+
Or you can mark specific accounts as "Correlate later" to ignore them now and resolve them in later iteration.
+
If you did the previous steps well, there should be just a handful of them.
+
Sometimes there are several accounts (or groups of accounts) which need to be reviewed in more detail and remedied.
To avoid getting stuck in this phase, you may simply mark these accounts for later review ("Don’t touch") and ignore any provisioning for them fow now.
(This is actually similar to the concepts of protected accounts, but having a different mark allows us to differentiate the accounts. We want them marked only temporarily, and they will be reported.)

TIP: We recommend to *review the accounts marked in previous iterations* to avoid a constant increase of their numbers.

After you’ve finished marking of your accounts, you can run the simulated _reconciliation_ task with _Development_ configuration again.
Your marked accounts shouldn’t be reported to be deactivated anymore.
Orphaned accounts which aren’t marked should be still reported as to be deactivated.

Switch the resource, object type configuration and all synchronization actions except for `Unmatched` situation to `Active` lifecycle state.
Switch the synchronization action for `Unmatched` situation to `Draft` lifecycle state (to keep the reaction temporarily disabled), and:

. Run the simulated _reconciliation_ task on AD resource using _Production_ configuration.
. Then have a look at the simulation results in midPoint GUI (interactively). Orphaned accounts shouldn’t be touched anymore - we will resolve them later, the synchronization configuration for them won't be used now (just in simulations).

Correlate the majority of your accounts now:

. Run the _reconciliation_ task on AD resource.
. Check the correlation statistics (watch for *Linked* situation)
. Majority of your accounts should be linked to their midPoint owners.


Of course, you’re doing this for the first time.
Chances are that you haven’t got all your configuration exactly right at the first try.
You may even need to update your HR resource configuration (e.g. if you forgot to import employee number) and reimport HR data.
Therefore, we assume you will work in iterations.
Simulations will guide you all the way.

== Import Active Directory usernames

Until now, users in midPoint have been created with employee number (or similar) attribute from HR.
But your users already have Active Directory usernames.
We can reuse them also for midPoint users - the advantage will be more obvious later, if we switch the midPoint authentication mechanism to use Active Directory.

.Please refer to the following documentation:
* xref:/midpoint/reference/admin-gui/resource-wizard/#mappings[Resource wizard - part Mappings]
* xref:/midpoint/reference/admin-gui/resource-wizard/#wizard-for-task-creation[Resource wizard - part Wizard for task creation]


You can see this step in action in the First Steps Methodology webinar video:

video::suo775ym_PE[youtube,title="Step 6: Import Usernames from Target System",start="2461"]


Re-configure the original HR inbound mapping for midPoint username: set its strength to _weak_.
This allows to still create midPoint users who have no Active Directory account, but AD username will have higher priority.

Re-configure your Active Directory resource: add a new _inbound_ mapping from AD's login attribute to midPoint username.
The mapping will be created as _strong_ by default, to take precedence over HR, but keep the mapping lifecycle state `Proposed` (simulation) for now.

Simulate the username import:

. Run the simulated or  _reconciliation_ task on AD resource using _Development_ configuration (as the mapping we're interested in is in `Proposed` lifecycle state).
. Then have a look at the simulation results in midPoint GUI (interactively).

For all users with Active Directory account, midPoint will indicate username change.
Inspect the changes and fix the username mapping in Active Directory if needed.

Re-configure your Active Directory inbound mapping: set it to `Active` lifecycle state.

.Optional step:
[TIP]
====

Simulate the username import once again:

. Run the simulated _reconciliation_ task on AD resource using _Production_ configuration.
. Then have a look at the simulation results in midPoint GUI (interactively).

Inspect the changes and fix the username mapping in Active Directory if needed, before you turn import them for real.
====

Import the usernames now:

. Run the _reconciliation_ task on AD resource.
. Majority of your midPoint users should be renamed according to their Active Directory usernames.
. Users without accounts in Active Directory (e.g. still uncorrelated) will keep their original usernames from HR (based on e.g. employee number). Such users (without Active Directory accounts) can be easily found in midPoint using GUI.

== Clean Up The Accounts

After the majority of the accounts have been correlated and usernames imported, we can handle the orphaned accounts (in situation `Unmatched`).
You have already marked your accounts (and intentionally not marked some of them).

.Please refer to the following documentation:

* xref:/midpoint/reference/admin-gui/resource-wizard/#synchronization[Resource wizard - part Synchronization]

You can see this step in action in the First Steps Methodology webinar video:

video::suo775ym_PE[youtube,title="Step 6.1: Clean Up Orphaned Accounts",start="2723"]


You are ready for clean up procedure:

. re-configure synchronization action for `Unmatched` situation: set it to `Active` lifecycle state.
. run _reconciliation_ task with Active Directory with _Production_ configuration to see what would happen one last time. If the simulation results correspond to what you’ve seen earlier with _Development_ configuration, continue.
. run _reconciliation_ task with Active Directory
. unmarked orphaned accounts should be deactivated
. additionally, the policy for orphaned accounts is set from now on, but the marked accounts will not be harmed.

During the clean up part (now or in one of the later iterations), you should check if there are any uncorrelatable accounts that can be correlated using additional correlation rules and/or operator intervention.

You can see this step in action in the First Steps Methodology webinar video:

video::suo775ym_PE[youtube,title="Step 6.2: Correlation with Operator Confirmation",start="2833"]

You should periodically review your xref:/midpoint/reference/concepts/mark/[marked accounts], especially those "temporary" states such as "To be decommissioned", "Don’t update" and "Correlate later".

You should also periodically run reconciliation task with your Active Directory to detect and deactivate any future orphaned accounts.
Unmarking those accounts and running _reconciliation_ task with Active Directory will remove them.

This phase may seem as pointless phase.
Why not just go directly to automation?
That is what we really want!
However, assessment is all but pointless.
Automation can be done only after the assessment phase is done.
Attempts to automate processes with unreliable data are futile, they invariably lead to failures, usually a very expensive failures.
Speaking from a couple of decades of identity management experience, there is no such thing as reliable data, unless the data are cleaned up and systematically maintained with an assistance of identity management platform.
Simply speaking: you may think that your data is good, but it is not.

== Prepare Active Directory for Provisioning

Before turning on automation, we need to ensure the provisioning configuration for Active Directory resource is correct.
Especially if you’re preparing the configuration in iterations, you need to make sure you’re going right direction.
Simulations will guide you all the way.

.Please refer to the following documentation:

* xref:/midpoint/reference/admin-gui/resource-wizard/#mappings[Resource wizard - part Mappings]
* xref:/midpoint/reference/admin-gui/resource-wizard/#activation[Resource wizard - part Activation]
* xref:/midpoint/reference/admin-gui/resource-wizard/#credentials[Resource wizard - part Credentials]
* xref:/midpoint/reference/admin-gui/resource-wizard/#wizard-for-task-creation[Resource wizard - part Wizard for task creation]


You can see this step in action in the First Steps Methodology webinar video:

video::suo775ym_PE[youtube,title="Step 7: Enable Provisioning to Target System",start="3088"]

Prepare / update outbound attribute mappings for your Active Directory attributes that you wish to provision.
If you want to force midPoint policy for attributes, you would need to make your mappings strong (this is default if you use GUI to create the mappings).
Set your mappings' lifecycle state attributes to `Proposed` to allow simulations.

Prepare / update outbound password mapping(s) for your Active Directory:

. to generate _initial_ (strength: weak) random password for any _new_ Active Directory account from now on.
The password will be forgotten; users need to cooperate with AD administrators or Helpdesk to gain their first credentials.
. to allow passing midPoint password changes to Active Directory (if you wish to use midPoint for AD password changes).
. set your credentials mappings' lifecycle state to `Proposed` to allow simulations.

Passwords may be also changed via Active Directory as usual (or both).

Prepare / update outbound activation mapping(s) for your Active Directory:

. to enable/disable Active Directory accounts based on midPoint user's Lifecycle state
. (optional) xref:/midpoint/reference/resources/resource-configuration/schema-handling/activation/#predefined-activation-mapping[configuration] for Disable instead of delete, Delayed delete etc. - if needed
. set your activation mappings(s') lifecycle state to `Proposed` to allow simulations.

NOTE: midPoint authentication against Active Directory (or LDAP) is assumed for later steps.

Then you can start your simulations:

. Run the simulated _reconciliation_ task on AD resource using _Development_ configuration.
. Then have a look at the simulation results in midPoint GUI (interactively).
. Inspect the results: if midPoint would change existing attributes, states or even passwords in Active Directory or add new values, there should be a reason for, e.g.: policy vs data inconsistency, such as:
.. Active Directory attributes are incorrect/missing, midPoint attributes based on HR data are correct.
.. Active Directory attributes are correct, midPoint attributes based on HR data are incorrect
.. mappings have errors (you need to correct them)
. Fix data vs policy inconsistency by using one or several mechanisms:
.. let midPoint to override data in Active Directory
.. fix data in HR/midPoint and reimport the user(s)
.. adjust midPoint policies (e.g. outbound attribute mappings)
.. define exceptions for specific accounts (e.g. using marks)
.. escalate the situation to let someone help (or decide)
. Repeat the process until all simulated changes make sense and can be executed for real

*When all the inconsistencies are resolved, you’re prepared.*
You can turn on the provisioning:

. Set all required outbound mappings including the mappings for activation and credentials to `Active` lifecycle state
. Run the simulated _reconciliation_ task on AD resource using _Production_ configuration
. Then have a look at the simulation results in midPoint GUI (interactively) one last time.
. Run the _reconciliation_ task on AD resource

Your Active Directory resource is now configured.
Data inconsistency has been fixed.
Policy is defined, applied and will be followed from now on.
There is no automation between HR and midPoint yet, but we’re already prepared for it.

.Simulation notes
[NOTE]
====
. When switching from `Proposed` to `Active` lifecycle state, use also simulation with _Production_ configuration before using the feature in real execution, if possible (usually when the real execution task is not yet running) - this is as close to the real task execution as possible.

. When switching the configuration from `Proposed` to `Active` lifecycle state, be sure to switch all relevant configuration. Otherwise, you might see different behaviour when simulating with _Development_ configuration and _Production_ configuration / real task execution.

. Try not to simulate several unrelated scenarios at the same time, otherwise switching just parts of the configuration from `Proposed` to `Active` lifecycle state may be challenging. You might see different behaviour when simulating with _Development_ configuration and _Production_ configuration / real task execution.

====

You can continue to xref:automation/[Automation] step or return to xref:kick-off/[Kick-off] step.