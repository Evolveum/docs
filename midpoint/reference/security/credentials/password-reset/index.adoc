= Password Reset Configuration
:page-nav-title: Password Reset
:page-toc: top

++++
{% include since.html since="4.7" %}
++++

New authentication modules were implemented to provide more flexible and convenient flow for password reset functionality.

It is quite common that from time to time a user forgets their password and seeks the possibility to reset it.
Almost every system provides some capabilities how the password might be reset.
MidPoint isn't different.
The password reset feature has been a part of midPoint since version 3.5, and in version 4.7 it was significantly improved.

Every time a user needs to reset their password, they first need to make a request to do it.
Using the midPoint GUI, it means that the user needs to click on the *_Reset password_* link.
After the user requests a password reset, authentication configuration takes its place.
Depending on the complexity of the environment and requirements, this configuration might differ.
In some cases, it might be as simple as sending an e-mail to the user with a link used to authenticate them.
In other cases, it might require multiple different steps to verify that the user is who they claim to be.
Often, authentication configuration and therefore the number of required steps to authenticate the user depends on who they are.
For example, different authentication options might be available for contractors than for employees, and authentication options might differ for students and teachers.

To configure authentication for password reset, the xref:/midpoint/reference/security/authentication/flexible-authentication/configuration/[flexible authentication] feature needs to be used.
Flexible authentication configuration is part of the xref:/midpoint/reference/security/security-policy/[security policy configuration].
In previous midPoint versions, only the global security policy configuration, referenced from system configuration, was taken into account during password reset.
Since midPoint 4.7, it is possible to use multiple security policies defined in different places, such as system configuration, organization, and archetype.
All security policies applicable to the user are merged together, and as a result, the authentication flow is computed.

The Password reset feature is disabled by default.
The following text describes how to enable and configure this feature.

== Enabling Password Reset

To enable the password reset feature, it has to be configured in the _global_ security policy referenced from the system configuration.

NOTE: The password reset feature can only be enabled globally.
Enabling password reset functionality means that there will be a link to _Reset password_ shown right on the login page.
Since the login page is displayed and evaluated at the beginning, at this time there is no chance to know who the user is.
Therefore, no other than global enabling of password reset makes sense.

This feature is enabled by defining the `credentialsReset` item in the global security policy.
It specifies the details of the password reset process, for example, the steps for user authentication before the new password can be set.
These steps are defined by using the `authenticationSequenceName` item, which points to an authentication sequence that describes the process.

After everything is set up, the _Reset password_ link will be shown on the login page as shown in Figure 1.

.Login page with *Reset password* link.
image::login-panel.png[Login page with _Reset password_ link,width=300,align="center"]

But we are not there yet.
There are a couple of components that must be in place to enable this feature:

. `credentialsReset` item,
. authentication modules, their sequence, and credentials used,
. notifications (if using email or SMS to communication with users).

Let us briefly describe them using the following example.

=== A Realistic Example

Let us assume we want to implement a three-stage password reset process:

. After requesting the password reset, the user has to enter their user name.
. If the user name is correct and there is a password hint for that user, the hint is shown.
. If the hint does not help the user recall the password, an email with a password reset link is sent to them.

The security policy configuration should include the following:

.Security policy configuration
[source,xml]
----
<securityPolicy xmlns="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
                oid="00000000-0000-0000-0000-000000000120">
    <name>Default Security Policy</name>
    <authentication>
        <modules>
            <!-- default modules (loginForm and so on) are not shown here -->
            <mailNonce> <!--3-->
                <identifier>mailNonce</identifier>
                <credentialName>mailNonce</credentialName>
            </mailNonce>
            <focusIdentification> <!--1-->
                <identifier>focusName</identifier>
                <item>
                    <path>name</path>
                    <matchingRule>polyStringNorm</matchingRule>
                </item>
            </focusIdentification>
            <hint> <!--2-->
                <identifier>passwordHint</identifier>
            </hint>
        </modules>
        <!-- default sequences (admin-gui-default and so on) are not shown here -->
        <sequence>
            <identifier>simple-password-reset</identifier>
            <channel>
                <channelId>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#resetPassword</channelId>
                <urlSuffix>resetPassword</urlSuffix>
            </channel>
            <module> <!--1-->
                <identifier>focusName</identifier>
                <order>10</order>
                <necessity>requisite</necessity>
            </module>
            <module> <!--2-->
                <identifier>passwordHint</identifier>
                <order>20</order>
                <necessity>optional</necessity>
                <acceptEmpty>true</acceptEmpty>
            </module>
            <module> <!--3-->
                <identifier>mailNonce</identifier>
                <order>30</order>
                <necessity>required</necessity>
            </module>
        </sequence>
        <!-- ... -->
    </authentication>
    <credentials>
        <!-- definition for password credential is not shown here -->
        <nonce> <!--3-->
            <name>mailNonce</name>
            <maxAge>PT24H</maxAge>
            <lockoutMaxFailedAttempts>3</lockoutMaxFailedAttempts>
            <lockoutFailedAttemptsDuration>PT3M</lockoutFailedAttemptsDuration>
            <lockoutDuration>PT15M</lockoutDuration>
        </nonce>
    </credentials>
    <credentialsReset> <!--4-->
        <identifier>global-credentials-reset</identifier>
        <authenticationSequenceName>simple-password-reset</authenticationSequenceName>
    </credentialsReset>
</securityPolicy>
----
<1> This module is used to identify which user is going to reset their password.
It has a definition in the `modules` section and a use in the `simple-password-reset` sequence.
<2> This module provides a password hint (if present).
Again, it has a definition in `modules` and a use in the sequence.
<3> This module defines an authentication using a nonce that is sent to the user via email.
It is defined in `modules`, in the sequence, and finally - because nonce is a type of credentials - also in the `credentials` section.
The nonce credential definition tells midPoint e.g. about the time validity for the link, lock-out strategy, and optionally a value generation configuration.
<4> Finally, the `credentialsReset` enables the "password reset" feature, and designates `simple-password-reset` as the sequence of steps that should be applied.

The details of the configuration are described in the following section.

NOTE: To make to solution fully functional, the notifications must be set up.
The following snipped should be put into the system configuration object.

.Notification configuration (in system configuration)
[source, xml]
----
<notificationConfiguration>
    <handler>
        <passwordResetNotifier>
            <recipientExpression>
                <script> <!--1-->
                    <code>requestee.emailAddress</code>
                </script>
            </recipientExpression>
            <bodyExpression>
                <script>
                    <code> <!--2-->
                        import com.evolveum.midpoint.notifications.api.events.ModelEvent
                        import com.evolveum.midpoint.xml.ns._public.common.common_3.UserType

                        def user = (event as ModelEvent).focusContext.objectNew?.asObjectable() as UserType
                        def link = midpoint.createPasswordResetLink(user)

                        "Did you request password reset? If yes, click on the link below:\n\n$link\n"
                    </code>
                </script>
            </bodyExpression>
            <transport>mail</transport>
        </passwordResetNotifier>
    </handler>
    <mail> <!--3-->
        <redirectToFile>mail.log</redirectToFile>
    </mail>
</notificationConfiguration>
----
<1> Specifies that `emailAddress` property will be used to obtain user's email address.
<2> Provides the body of the mail sent.
<3> Normally, a mail server configuration should be present here.
For demonstration purposes, the `redirectToFile` instruction is used instead.
All messages will be recorded to that file, instead of being sent out via email.
Please adapt this by using your specific mail server configuration here.

After providing the above configuration, you can try invoking the "reset password" feature.

== Details of the Password Reset Configuration

This section explains in more detail how the authentication sequences defined in different places play together and how the flow will look.

=== Security Policy in System Configuration

Let's start with the example of authentication sequence with identifier `simple-password-reset` in <<A Realistic Example>> above.

This sequence is defined on _global level_, which means that the security policy containing this sequence (`Default Security Policy`) is referenced from system configuration.

The sequence looks like this:

.Password reset sequence
[source, xml]
----
<sequence>
    <identifier>simple-password-reset</identifier>
    <channel>
        <channelId>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#resetPassword</channelId>
        <urlSuffix>resetPassword</urlSuffix>
    </channel>
    <module>
        <identifier>focusName</identifier>
        <order>10</order>
        <necessity>requisite</necessity>
    </module>
    <module>
        <identifier>passwordHint</identifier>
        <order>20</order>
        <necessity>optional</necessity>
        <acceptEmpty>true</acceptEmpty>
    </module>
    <module>
        <identifier>mailNonce</identifier>
        <order>30</order>
        <necessity>required</necessity>
    </module>
</sequence>
----

It means that during the password reset procedure, up to three modules will be evaluated:

.Modules evaluated in the simple password reset sequence
[%autowidth]
|===
| Module identifier | Module type | Purpose

| `focusName`
| xref:/midpoint/reference/security/authentication/flexible-authentication/configuration.adoc#_focusIdentification[`focusIdentification`]
| Identify the user whose password is going to be reset.

| `passwordHint`
| xref:/midpoint/reference/security/authentication/flexible-authentication/configuration.adoc#_hint[`hint`]
| Give user a chance to recall the password by showing a password hint.

| `mailNonce`
| xref:/midpoint/reference/security/authentication/flexible-authentication/configuration.adoc#_mailNonce[`mailNonce`]
| Establish the identity of the user by sending them a mail with a randomly generated nonce.
|===

==== Focus Identification

The first module is `focusName` (of the `focusIdentification` type), whose aim is to find and identify the user in midPoint.
In this specific situation, an attempt to find the user according to their `name` with the matching rule set to `polyStringNorm` will be performed.
When executed, the user is presented with the form shown in Figure 2.

.The focus identification module
image::focus-identification-module.png[Focus identification module,width=300,align="center"]

If the user is not found, or if more than one user is found, the authentication flow ends, as it is not possible to identify such a user.
If the user exists, the authentication sequence continues with the next module (`passwordHint`).

==== Password Hint

The second module is `passwordHint` (of `hint` type).
The goal here is to show a password hint to the user, if such a hint is defined.
The behavior in the case of missing hint is driven by the `acceptEmpty` property.
Because it is set here to `true`, this step is skipped for users that have no hint defined.

If the hint is present, it is shown to the user.
After that, the user has two options.
Either they remember their password and continue with standard login, or they still don't remember the password and can continue with the reset password flow.
The hint module is shown in Figure 3.

.The hint module
image::hint-module.png[Hint module,width=300,align="center"]

If the user decides to continue because, even after the hint was shown, they couldn't remember their password, the `mailNonce` module is the next one.

==== Mail Nonce

First, a nonce is generated and saved to the user's credentials data in the midPoint repository.
Simultaneously, the notification is sent to the user's email address with the link that can be used to authenticate the user.
The following screen is shown to the user:

.Mail nonce module
image::mail-nonce-module.png[Main nonce module,width=300,align="center"]

The user has to check their mailbox and click on the link sent in the mail.
After successful authentication, the user is prompted to reset their password, as shown in Figure 5.

// TODO update the screenshot
.Change password panel
image::change-password-panel.png[Change password panel,width=300,align="center"]

Such a sequence, when defined globally, is applicable to all users, who will try to perform a password reset.

=== Security Policy for Organization

Now assume, that we have different types of users company and thus in midPoint.
For example, there are _Interns_ which belong to a organizational unit with the same name, _Interns_.
Interns should use security questions authentication prior to the mailNonce authentication.
However, not all _interns_ has filled the answers for the security questions.
In such a case, the authentication sequence should be extended with the new module, securityQuestions, but applicable only if the security questions were previously filled.
This authentication extension is placed to another security policy which is referenced from organization.
Example bellow show the configuration of security policy.

[source,xml]
--------
<authentication>
    <modules>
        <securityQuestionsForm>
            <identifier>securityQuestionsForm</identifier>
        </securityQuestionsForm>
    </modules>
    <sequence>
        <identifier>userPasswordResetAuth</identifier>
        <description>A sequence used for password reset</description>
        <channel>
            <channelId>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#resetPassword</channelId>
            <urlSuffix>resetPassword</urlSuffix>
        </channel>
        <module>
            <identifier>securityQuestionsForm</identifier>
            <order>25</order> <!-- order greater than for hint module, but lesser than for mailNonce module -->
            <acceptEmpty>true</acceptEmpty>
            <necessity>sufficient</necessity>
        </module>
    </sequence>
</authentication>

--------

Above stated policy is merged with the global one and as a result, at most four modules are used during the authentication phase of password reset.
The flow starts as described before, with the focus identification and continues with hint if defined.
But after hint module, prior to evaluating mailNonce module, securityQuestion module is evaluated.
Again, since `acceptEmpty` is set to true, if the user hasn't set their answers, the module is skipped and the sequence continues with mailNonce module.
But, if the answers exist, user is asked to provide them.
After the answers were provided, and they were correct, user is authenticated and change password panel (picture 5) is shown.
However, if the answers were not provided, the sequence continue with the mailNonce module.
Example of the security question module is shown in picture 6.

.Security questions module
image::security-questions-module.png[Security questions module,60%,align="center"]

=== Security Policy for Archetype

In some cases, defining global or organizational unit policy might not be sufficient.
For example, let's assume there are internal and external employees in the company.
Internal employees have some kind of employee identification number (employeeId), but external don't.
There is a requirement, that the internal employees have to use this employeeId while authenticating for password reset.
Since the requirement is that only internal employees have to use employeeId and there already exists archetype
_Internal employee_ in midPoint, we will define new security policy and reference it from this archetype.

Bellow is the example of such policy:

[source,xml]
--------
<authentication>
    <modules>
        <attributeVerification>
            <identifier>attributeVerification</identifier>
            <path>employeeNumber</path>
        </attributeVerification>
    </modules>
    <sequence>
        <name>userPasswordResetAuth</name>
        <description>A sequence used for password reset</description>
        <channel>
            <channelId>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#resetPassword</channelId>
            <urlSuffix>resetPassword</urlSuffix>
        </channel>
        <module>
            <identifier>attributeVerification</identifier>
            <order>40</order>
            <necessity>required</necessity>
        </module>
    </sequence>
</authentication>
--------

Above stated policy is merged with the global one and as a result, four modules are used during the authentication phase of password reset.

The flow is very similar than one described in security policy for system configuration.
The only difference is, that after mailNonce module was evaluated, the authentication sequence continues with attributeVerification module.
attributeVerification module runs apart from the result of the mailNonce module.
So it doesn't matter is the module was successful or failed, attributeVerification module will be evaluated.
If all modules are successful, change password panel is shown (picture 5).
Example of attributeVerification module is shown in the picture 7.

.Attribute verification module
image::attribute-verification-module.png[Attribute verification module,60%,align="center"]


Full list of xref:/midpoint/reference/security/authentication/flexible-authentication/configuration/#module-configuration[supported authentication modules] are listed in documentation for xref:/midpoint/reference/security/authentication/flexible-authentication/configuration/[Flexible authentication].

== Other configuration

For some authentication modules, additional configuration might be required, such as:

* a need to define value policy for nonce generation when using mailNonce module,
* a need to define security questions for securityQuestionsForm module,
* a need to define how many attempts can be made for specific module authentication.

For such a configuration, please see section about xref:/midpoint/reference/security/security-policy/#configuring-credentials[credentials policies configuration]

When the nonceMail authentication module is used, at some point _nonce_ has to be generated and delivered to the user.
Currently, it is sent in the validation link to the user's mail.
To be able to send this confirmation link to the user, it is needed to configure notifications (in the system configuration).
Example for such configuration is shown in the following sample:

.Example for notification configuration
[source,xml]
----
<notificationConfiguration>
    <handler>
        <passwordResetNotifier>
            <recipientExpression>
                <script>
                    <code>requestee.emailAddress</code>
                </script>
            </recipientExpression>
            <bodyExpression>
                <script>
                    <code>
                        import com.evolveum.midpoint.notifications.api.events.ModelEvent
                        import com.evolveum.midpoint.xml.ns._public.common.common_3.UserType

                        def user = (event as ModelEvent).focusContext.objectNew?.asObjectable() as UserType
                        def link = midpoint.createPasswordResetLink(user)

                        "Did you request password reset? If yes, click on the link below:\n\n$link\n"
                    </code>
                </script>
            </bodyExpression>
            <transport>mail</transport>
        </passwordResetNotifier>
    </handler>
    <mail>
        <redirectToFile>mail.log</redirectToFile>
    </mail>
</notificationConfiguration>
----

While using custom body expression don't forget to generate the link.
There is a method in midPoint function library which will generate the link - midpoint.createPasswordResetLink(userType).


== See also
* xref:/midpoint/reference/security/security-policy/[Security Policy]

* xref:/midpoint/reference/security/credentials/password-policy/[Password Policy]

* xref:/midpoint/reference/security/authentication/flexible-authentication/configuration/[Flexible Authentication]

* xref:/midpoint/reference/misc/notifications/configuration/[Notifications Configuration]
