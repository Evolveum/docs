= Password Reset Configuration
:page-nav-title: Password Reset
:page-toc: top
:page-upkeep-status: red

++++
{% include since.html since="4.7" %}
++++

New authentication modules were implemented to provide more flexible and convenient flow for password reset functionality.

It is quite common that from time to time a user forgets their password and seek a possibility to reset it.
Almost every system provides some capabilities how the password might be reset.
MidPoint isn't different.
The password reset feature has been a part of midPoint since version 3.5 and in version 4.7 was significantly improved.

Everytime a user needs to reset their password, they first need to make a request to do it.
Using midPoint GUI it means that the user needs to click on the *_Reset password_* link.
After the user requested password reset, authentication configuration takes its place.
Depending on the complexity of the environment and requirements, this configuration might differ.
In some cases it might be as simple as just sending an e-mail to the user with link used to authenticate them.
In other cases it might require multiple different steps to verify that the user is who they claim to be.
Often, authentication configuration and therefore the number of the required steps to authenticate the user depends on who they are.
For example, different authentication options might be available for contractors than employees, also authentication options might differ for students and teachers.

To configure authentication for password reset, xref:/midpoint/reference/security/authentication/flexible-authentication/configuration/[flexible authentication] feature needs to be used.
Flexible authentication configuration is part of the xref:/midpoint/reference/security/security-policy/[security policy configuration].
In previous midPoint versions, only one, global security policy configuration, referenced from system configuration, was taken into account during password reset.
Since midPoint 4.7, it is possible to use multiple security policies defined on different places, such as system configuration, organization, and archetype.
All security policies applicable for the user are merged together and as a result, authentication flow is computed.

Password reset feature is disabled by default.
The following text describes how to enable and configure this feature.

== Enabling Password Reset

To enable password reset feature, it has to be configured in the _global_ security policy referenced from system configuration.
Password reset can be enabled only globally.
Enabling password reset functionality means, that there will be link to _Reset password_ shown on the login page.
Since the login page is displayed and evaluated at the beginning, at this time there is no chance to know who the user is.
Therefore, no other than global enabling of password reset makes sense.

Password reset feature is enabled by defining:

. `credentialsReset` element should be defined in security policy in order to specify the details of the password reset process. For example, the steps of the user authentication during password reset should be configured here.

. `authenticationSequenceName` element points to the certain authentication sequence. Sequence can consist of different modules which are then applied during authentication phase of password reset. The example of the configuration is shown bellow:

[source,xml]
-----------------
<credentialsReset>
    <authenticationSequenceName>userPasswordResetAuth</authenticationSequenceName>
</credentialsReset>
-----------------

After enabling password reset funcionality, _Reset password_ link is shown on login page as shown in the picture 1.

.Login page with *Reset password* link.
image::login-panel.png[Login page with _Reset password_ link,60%,align="center"]

== Authentication Sequence Configuration for Reset Password

This section tries to explain in more detail how the authentication sequences defined in different places play together and how the flow will look.

=== Security Policy in System Configuration
Let's start with following example of authentication sequence with identifier `userPasswordResetAuth` .
This sequence is defined on _global level_ (which means that the security policy containing this sequence is referenced from system configuration).

[source,xml]
-----------------
<securityPolicy>
...
   <authentication>
     <modules>
        <mailNonce>
            <identifier>MailNonce</identifier>
            <description> Authentication based on mail message with a nonce. Used for user registratio.</description>
            <credentialName>mailNonce</credentialName>
        </mailNonce>
        <focusIdentification>
            <identifier>focusId</identifier>
            <item>
                <path>name</path>
                <matchingRule>polyStringNorm</matchingRule>
            </item>
        </focusIdentification>
        <hint>
            <identifier>hintAuth</identifier>
        </hint>
      </modules>
      <sequence>
        <identifier>userPasswordResetAuth</identifier>
        <description>Just a nonce mail to validate e-mail address.</description>
        <channel>
            <channelId>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#resetPassword</channelId>
            <urlSuffix>resetPassword</urlSuffix>
        </channel>
        <module>
            <identifier>focusId</identifier>
            <necessity>requisite</necessity>
            <order>10</order>
        </module>
        <module>
            <identifier>hintAuth</identifier>
            <necessity>optional</necessity>
            <acceptEmpty>true</acceptEmpty>
            <order>20</order>
        </module>
        <module>
            <identifier>MailNonce</identifier>
            <order>30</order>
            <necessity>required</necessity>
        </module>
      </sequence>
      ....
   </authentication>
   <credentialsReset>
      <authenticationSequenceName>userPasswordResetAuth</authenticationSequenceName>
   </credentialsReset>
</securityPolicy>
-----------------

If above stated configuration is executed, it means that during the authentication phase of password reset, at most three modules will be evaluated - focusIdentification, hint and mailNonce.
First module is _focusIdentification_ which aim is to find, and identify user in midPoint. In this specific situation, attempt to find the user according to their `name` with matching rule set to `polyStringNorm` will be performed. This module is presented as shown in the picture 2.

.Focus identification module
image::focus-identification-module.png[Focus identification module,60%,align="center"]

If the user is not found, or more than one user is found, authentication flow ends as it is not possible to identify such a user.
If the user exists, the authentication sequence continues with hint module.
Since the configuration for hint module container `acceptEmpty` attribute set to true, it is first evaluated, if the identified user has defined the hint for the password.
If the hint is present, it is shown to the user.
After the hint is shown, user has two options.
Either they remembered their password and continue with standard login, or they still don't remember the password and can continue with the reset password flow.
Hint module is shown in the picture 3.

.Hint module
image::hint-module.png[Hint module,60%,align="center"]

If they decide to continue, because even after the hint was shown they couldn't remember their password, `mailNonce` module is the next.
First, nonce is generated and saved to user's credentials.
Simultaneously, the notification is sent to the user's email address with the link which can be used to authenticate the user.
The following screen is shown to the user

.Mail nonce module
image::mail-nonce-module.png[Main nonce module,60%,align="center"]

User has to check their mailbox and click on the link sent in the mail.
After successful authentication, user is prompted to reset their password, as show in the picture 5.

.Change password panel
image::change-password-panel.png[Change password panel,60%,align="center"]

Such a sequence when defined globally is applicable for all users which will try to perform password reset.

=== Security Policy for Organization

Now assume, that we have different types of users company and thus in midPoint.
For example, there are _Interns_ which belong to a organizational unit with the same name, _Interns_.
Interns should use security questions authentication prior to the mailNonce authentication.
However, not all _interns_ has filled the answers for the security questions.
In such a case, the authentication sequence should be extended with the new module, securityQuestions, but applicable only if the security questions were previously filled.
This authentication extension is placed to another security policy which is referenced from organization.
Example bellow show the configuration of security policy.

[source,xml]
--------
<authentication>
    <modules>
        <securityQuestionsForm>
            <identifier>securityQuestionsForm</identifier>
        </securityQuestionsForm>
    </modules>
    <sequence>
        <identifier>userPasswordResetAuth</identifier>
        <description>A sequence used for password reset</description>
        <channel>
            <channelId>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#resetPassword</channelId>
            <urlSuffix>resetPassword</urlSuffix>
        </channel>
        <module>
            <identifier>securityQuestionsForm</identifier>
            <order>25</order> <!-- order greater than for hint module, but lesser than for mailNonce module -->
            <acceptEmpty>true</acceptEmpty>
            <necessity>sufficient</necessity>
        </module>
    </sequence>
</authentication>

--------

Above stated policy is merged with the global one and as a result, at most four modules are used during the authentication phase of password reset.
The flow starts as described before, with the focus identification and continues with hint if defined.
But after hint module, prior to evaluating mailNonce module, securityQuestion module is evaluated.
Again, since `acceptEmpty` is set to true, if the user hasn't set their answers, the module is skipped and the sequence continues with mailNonce module.
But, if the answers exist, user is asked to provide them.
After the answers were provided, and they were correct, user is authenticated and change password panel (picture 5) is shown.
However, if the answers were not provided, the sequence continue with the mailNonce module.
Example of the security question module is shown in picture 6.

.Security questions module
image::security-questions-module.png[Security questions module,60%,align="center"]

=== Security Policy for Archetype

In some cases, defining global or organizational unit policy might not be sufficient.
For example, let's assume there are internal and external employees in the company.
Internal employees have some kind of employee identification number (employeeId), but external don't.
There is a requirement, that the internal employees have to use this employeeId while authenticating for password reset.
Since the requirement is that only internal employees have to use employeeId and there already exists archetype
_Internal employee_ in midPoint, we will define new security policy and reference it from this archetype.

Bellow is the example of such policy:

[source,xml]
--------
<authentication>
    <modules>
        <attributeVerification>
            <identifier>attributeVerification</identifier>
            <path>employeeNumber</path>
        </attributeVerification>
    </modules>
    <sequence>
        <name>userPasswordResetAuth</name>
        <description>A sequence used for password reset</description>
        <channel>
            <channelId>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#resetPassword</channelId>
            <urlSuffix>resetPassword</urlSuffix>
        </channel>
        <module>
            <identifier>attributeVerification</identifier>
            <order>40</order>
            <necessity>required</necessity>
        </module>
    </sequence>
</authentication>
--------

Above stated policy is merged with the global one and as a result, four modules are used during the authentication phase of password reset.

The flow is very similar than one described in security policy for system configuration.
The only difference is, that after mailNonce module was evaluated, the authentication sequence continues with attributeVerification module.
attributeVerification module runs apart from the result of the mailNonce module.
So it doesn't matter is the module was successful or failed, attributeVerification module will be evaluated.
If all modules are successful, change password panel is shown (picture 5).
Example of attributeVerification module is shown in the picture 7.

.Attribute verification module
image::attribute-verification-module.png[Attribute verification module,60%,align="center"]


Full list of xref:/midpoint/reference/security/authentication/flexible-authentication/configuration/#module-configuration[supported authentication modules] are listed in documentation for xref:/midpoint/reference/security/authentication/flexible-authentication/configuration/[Flexible authentication].

== Other configuration

For some authentication modules, additional configuration might be required, such as:

* a need to define value policy for nonce generation when using mailNonce module,
* a need to define security questions for securityQuestionsForm module,
* a need to define how many attempts can be made for specific module authentication.

For such a configuration, please see section about xref:/midpoint/reference/security/security-policy/#configuring-credentials[credentials policies configuration]

When the nonceMail authentication module is used, at some point _nonce_ has to be generated and delivered to the user.
Currently, it is sent in the validation link to the user's mail.
To be able to send this confirmation link to the user, it is needed to configure notifications (in the system configuration).
Example for such configuration is shown in the following sample:

.Example for notification configuration
[source,xml]
----
<passwordResetNotifier>
    <recipientExpression>
    	<script>
			<code>return requestee.getEmailAddress()</code>
        </script>
    </recipientExpression>
    <bodyExpression>
        <script>
            <code>

            	import com.evolveum.midpoint.notifications.api.events.ModelEvent
                modelEvent = (ModelEvent) event
                newUser = modelEvent.getFocusContext().getObjectNew();
                userType = newUser.asObjectable();

	            link = midpoint.createPasswordResetLink(userType)
		        bodyMessage = "Did you request password reset? If yes, click on the link below \n" + link

		        return bodyMessage;
            </code>
        </script>
	</bodyExpression>
    <transport>mail</transport>
</passwordResetNotifier>
----

While using custom body expression don't forget to generate the link.
There is a method in midPoint function library which will generate the link - midpoint.createPasswordResetLink(userType).


== See also
* xref:/midpoint/reference/security/security-policy/[Security Policy]

* xref:/midpoint/reference/security/credentials/password-policy/[Password Policy]

* xref:/midpoint/reference/security/authentication/flexible-authentication/configuration/[Flexible Authentication]

* xref:/midpoint/reference/misc/notifications/configuration/[Notifications Configuration]
